<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Totem</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container glass-effect">
        <div class="header">
            <a href="index.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
                <span>Torna alla Home</span>
            </a>
            <div class="logo-container">
                <img src="https://www.istitutoboselli.edu.it/wp-content/uploads/2024/04/logo-boselli-ritaglio-1.png" alt="Logo IIS P.Boselli" class="school-logo">
            </div>
            <div class="admin-header-controls">
                <span id="adminUser" class="admin-user"></span>
                <button onclick="handleLogout()" class="admin-button-small">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
            <i class="fas fa-cog music-icon"></i>
            <h1>Admin Panel</h1>
            <div class="subtitle">Gestione Sistema Totem</div>
        </div>

        <div id="adminContent" class="admin-panel" style="display: none;">
            <!-- Carousel Management Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-images"></i> Gestione Carosello</h2>
                <div class="admin-controls">
                    <div class="location-selector">
                        <label for="carouselLocation">Seleziona Sede:</label>
                        <select id="carouselLocation" onchange="loadCarouselContent()">
                            <option value="viasansovino">Via Sansovino</option>
                            <option value="vialuini">Via Luini</option>
                        </select>
                    </div>
                    <div class="action-buttons">
                        <button onclick="addCarouselItem()" class="admin-button-small">
                            <i class="fas fa-plus"></i> Nuovo Contenuto
                        </button>
                    </div>
                </div>
                <div id="carouselItemsList" class="carousel-items-list">
                    <!-- Carousel items will be loaded here -->
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-calendar-alt"></i> Gestione Calendario</h2>
                <div class="admin-controls">
                    <div class="filters">
                        <div class="location-filter">
                            <label for="calendarLocationFilter">Filtra per Sede:</label>
                            <select id="calendarLocationFilter" onchange="filterCalendarEvents()">
                                <option value="all">Tutte le Sedi</option>
                                <option value="TO1">TO1</option>
                                <option value="TO2">TO2</option>
                                <option value="TO3">TO3</option>
                            </select>
                        </div>
                        <div class="date-filter">
                            <label for="calendarDateFilter">Filtra per Data:</label>
                            <input type="date" id="calendarDateFilter" onchange="filterCalendarEvents()">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="addCalendarEvent()" class="admin-button-small">
                            <i class="fas fa-plus"></i> Nuovo Evento
                        </button>
                    </div>
                </div>
                <div id="calendarEventsList" class="substitutions-list">
                    <!-- Calendar events will be loaded here -->
                </div>
            </div>

            <!-- Substitutions Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-exchange-alt"></i> Gestione Sostituzioni</h2>
                <div class="admin-controls">
                    <div class="filters">
                        <div class="location-filter">
                            <label for="adminLocationFilter">Filtra per Sede:</label>
                            <select id="adminLocationFilter" onchange="filterAdminSubstitutions()">
                                <option value="all">Tutte le Sedi</option>
                                <option value="TO1">TO1</option>
                                <option value="TO2">TO2</option>
                                <option value="TO3">TO3</option>
                            </select>
                        </div>
                        <div class="date-filter">
                            <label for="adminDateFilter">Filtra per Data:</label>
                            <input type="date" id="adminDateFilter" onchange="filterAdminSubstitutions()">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="addSubstitution()" class="admin-button-small">
                            <i class="fas fa-plus"></i> Nuova Sostituzione
                        </button>
                        <button onclick="exportSubstitutions()" class="admin-button-small">
                            <i class="fas fa-download"></i> Esporta Sostituzioni
                        </button>
                    </div>
                </div>
                <div id="substitutionsList" class="substitutions-list">
                    <!-- Substitutions will be loaded here -->
                </div>
            </div>

            <!-- Organizational Structure Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-sitemap"></i> Gestione Organigramma</h2>
                <div class="admin-controls">
                    <div class="action-buttons">
                        <button onclick="addOrgNode()" class="admin-button-small">
                            <i class="fas fa-plus"></i> Aggiungi Nodo
                    </button>
                        <button onclick="saveOrgStructure()" class="admin-button-small">
                            <i class="fas fa-save"></i> Salva Struttura
                    </button>
                    </div>
                </div>
                <div id="orgStructureEditor" class="org-structure-editor">
                    <div id="orgTree" class="org-tree"></div>
                </div>
            </div>
        </div>

        <!-- Substitution Modal -->
        <div id="substitutionModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gestione Sostituzioni</h2>
                    <button onclick="closeSubstitutionModal()" class="close-button">&times;</button>
                </div>
                <form id="substitutionForm" onsubmit="handleSubstitutionSubmit(event)">
                    <div class="form-group">
                        <label for="substitutionDate">Data:</label>
                        <input type="date" id="substitutionDate" required>
                    </div>
                    <div class="form-group">
                        <label for="substitutionLocation">Sede:</label>
                        <select id="substitutionLocation" required>
                            <option value="TO1">TO1</option>
                            <option value="TO2">TO2</option>
                            <option value="TO3">TO3</option>
                        </select>
                    </div>
                    
                    <div id="substitutionsContainer">
                        <div class="substitution-entry">
                            <div class="substitution-row">
                    <div class="form-group">
                                    <label for="substitutionTimeSlot_0">Orario:</label>
                                    <select id="substitutionTimeSlot_0" required>
                            <option value="1">1° ora (8:00-9:00)</option>
                            <option value="2">2° ora (9:00-10:00)</option>
                            <option value="3">3° ora (10:00-11:00)</option>
                            <option value="4">4° ora (11:00-12:00)</option>
                            <option value="5">5° ora (12:00-13:00)</option>
                            <option value="6">6° ora (13:00-14:00)</option>
                                        <option value="7">7° ora (14:00-15:00)</option>
                                        <option value="8">8° ora (15:00-16:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                                    <label for="substitutionClass_0">Classe:</label>
                                    <input type="text" id="substitutionClass_0" required placeholder="es. 1A">
                    </div>
                    <div class="form-group">
                                    <label for="replacedTeacher_0">Docente Sostituito:</label>
                                    <input type="text" id="replacedTeacher_0" required>
                    </div>
                    <div class="form-group">
                                    <label for="substituteTeacher_0">Docente Sostituto:</label>
                                    <input type="text" id="substituteTeacher_0" required>
                    </div>
                                <button type="button" class="remove-substitution" onclick="removeSubstitutionEntry(this)" style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                    </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" onclick="addSubstitutionEntry()" class="add-button">
                            <i class="fas fa-plus"></i> Aggiungi Altra Sostituzione
                        </button>
                        <button type="submit" class="save-button">
                            <i class="fas fa-save"></i> Salva Tutte
                        </button>
                        <button type="button" onclick="closeSubstitutionModal()" class="cancel-button">
                            <i class="fas fa-times"></i> Annulla
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Calendar Event Modal -->
        <div id="calendarEventModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gestione Evento</h2>
                    <button onclick="closeCalendarEventModal()" class="close-button">&times;</button>
                </div>
                <form id="calendarEventForm" onsubmit="handleCalendarEventSubmit(event)">
                    <input type="hidden" id="eventId">
                    <div class="form-group">
                        <label for="eventDate">Data:</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventLocation">Sede:</label>
                        <select id="eventLocation" required>
                            <option value="all">Tutte le Sedi</option>
                            <option value="TO1">TO1</option>
                            <option value="TO2">TO2</option>
                            <option value="TO3">TO3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventTimeSlot">Orario:</label>
                        <select id="eventTimeSlot" required>
                            <option value="1">1° ora (8:00-9:00)</option>
                            <option value="2">2° ora (9:00-10:00)</option>
                            <option value="3">3° ora (10:00-11:00)</option>
                            <option value="4">4° ora (11:00-12:00)</option>
                            <option value="5">5° ora (12:00-13:00)</option>
                            <option value="6">6° ora (13:00-14:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventTitle">Titolo Evento:</label>
                        <input type="text" id="eventTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDescription">Descrizione:</label>
                        <textarea id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="save-button">Salva</button>
                        <button type="button" onclick="closeCalendarEventModal()" class="cancel-button">Annulla</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Carousel Item Modal -->
        <div id="carouselItemModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gestione Contenuto Carosello</h2>
                    <button onclick="closeCarouselItemModal()" class="close-button">&times;</button>
                </div>
                <form id="carouselItemForm" onsubmit="handleCarouselItemSubmit(event)">
                    <input type="hidden" id="carouselItemId">
                    <div class="form-group">
                        <label for="itemType">Tipo Contenuto:</label>
                        <select id="itemType" required onchange="toggleMediaInput()">
                            <option value="image">Immagine</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="itemTitle">Titolo:</label>
                        <input type="text" id="itemTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="itemFile">File:</label>
                        <input type="file" id="itemFile" accept="image/*,video/*" required>
                        <div id="filePreview" class="file-preview"></div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="save-button">Salva</button>
                        <button type="button" onclick="closeCarouselItemModal()" class="cancel-button">Annulla</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Org Node Modal -->
        <div id="orgNodeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gestione Nodo Organigramma</h2>
                    <button onclick="closeOrgNodeModal()" class="close-button">&times;</button>
                </div>
                <form id="orgNodeForm" onsubmit="handleOrgNodeSubmit(event)">
                    <input type="hidden" id="nodeId">
                    <div class="form-group">
                        <label for="parentId">Genitore:</label>
                        <select id="parentId"></select>
                    </div>
                    <div class="form-group">
                        <label for="nodeTitle">Titolo:</label>
                        <input type="text" id="nodeTitle" required placeholder="es. Dirigente Scolastico">
                    </div>
                    <div class="form-group">
                        <label for="nodeName">Nome:</label>
                        <input type="text" id="nodeName" required placeholder="es. Mario Rossi">
                    </div>
                    <div class="form-group">
                        <label for="nodeRole">Ruolo:</label>
                        <input type="text" id="nodeRole" required placeholder="es. Responsabile">
                    </div>
                    <div class="form-group">
                        <label for="nodeDescription">Descrizione:</label>
                        <textarea id="nodeDescription" rows="3" placeholder="Breve descrizione del ruolo e delle responsabilità"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="save-button">Salva</button>
                        <button type="button" onclick="closeOrgNodeModal()" class="cancel-button">Annulla</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="loginPrompt" class="login-prompt glass-effect">
            <i class="fas fa-lock"></i>
            <h2>Accesso Richiesto</h2>
            <p>Effettua l'accesso per gestire il sistema totem</p>
            <a href="admin-login.html" class="btn">
                <i class="fas fa-sign-in-alt"></i>
                Accedi
            </a>
        </div>

        <footer class="footer glass-effect">
            <p>© 2024 Totem Navigation | IIS P.Boselli Torino | Tutti i diritti riservati</p>
            <p class="footer-sub">Pannello di Amministrazione</p>
        </footer>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBY79WtkjTgPkY8GqbtZGbawL-PQXjgdHA",
            authDomain: "gestione-totem.firebaseapp.com",
            databaseURL: "https://gestione-totem-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gestione-totem",
            storageBucket: "gestione-totem.firebasestorage.app",
            messagingSenderId: "940742220177",
            appId: "1:940742220177:web:ec36d4958f6f02a948a230",
            measurementId: "G-Y4WT9HRDSY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Utility Functions
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function showError(message) {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'error-message';
            errorMessage.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <p>${message}</p>
            `;
            document.body.appendChild(errorMessage);
            setTimeout(() => {
                errorMessage.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => errorMessage.remove(), 300);
            }, 3000);
        }

        function showSuccess(message) {
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <p>${message}</p>
            `;
            document.body.appendChild(successMessage);
            setTimeout(() => {
                successMessage.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => successMessage.remove(), 300);
            }, 3000);
        }

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            const loginPrompt = document.getElementById('loginPrompt');
            const adminContent = document.getElementById('adminContent');
            const adminUser = document.getElementById('adminUser');
            
            if (user) {
                loginPrompt.style.display = 'none';
                adminContent.style.display = 'block';
                adminUser.textContent = `Admin: ${user.email}`;
                loadCarouselContent();
                loadSubstitutions('all', new Date().toISOString().split('T')[0]);
                loadCalendarEvents('all', new Date().toISOString().split('T')[0]);
            } else {
                loginPrompt.style.display = 'block';
                adminContent.style.display = 'none';
            }
        });

        // Handle logout
        window.handleLogout = async () => {
            try {
                await auth.signOut();
                window.location.href = 'admin-login.html';
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Errore durante il logout');
            }
        };

        // Carousel Management Functions
        window.addCarouselItem = () => {
            const modal = document.getElementById('carouselItemModal');
            const form = document.getElementById('carouselItemForm');
            
            document.getElementById('carouselItemId').value = '';
            document.getElementById('itemType').value = 'image';
            document.getElementById('itemTitle').value = '';
            document.getElementById('itemFile').value = '';
            document.getElementById('filePreview').innerHTML = '';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            modal.style.display = 'block';
            modal.classList.add('active');
        };

        window.closeCarouselItemModal = () => {
            document.getElementById('carouselItemModal').style.display = 'none';
        };

        window.toggleMediaInput = () => {
            const type = document.getElementById('itemType').value;
            const fileInput = document.getElementById('itemFile');
            fileInput.accept = type === 'image' ? 'image/*' : 'video/*';
        };

        window.handleCarouselItemSubmit = async (event) => {
            event.preventDefault();
            
            const location = document.getElementById('carouselLocation').value;
            const itemId = document.getElementById('carouselItemId').value;
            const type = document.getElementById('itemType').value;
            const title = document.getElementById('itemTitle').value;
            const file = document.getElementById('itemFile').files[0];

            if (!file) {
                alert('Seleziona un file');
                return;
            }

            try {
                // Verifica la corrispondenza tra tipo selezionato e tipo di file
                const fileType = file.type;
                if ((type === 'video' && !fileType.startsWith('video/')) ||
                    (type === 'image' && !fileType.startsWith('image/'))) {
                    alert('Il tipo di file non corrisponde al tipo selezionato');
                    return;
                }

                console.log('Caricamento file:', {
                    nome: file.name,
                    tipo: file.type,
                    dimensione: file.size
                }); // Debug log

                // Convert file to base64
                const base64Data = await fileToBase64(file);
                console.log('File convertito in base64, tipo:', type); // Debug log

                // Get current items to determine next order number
                const carouselRef = db.ref(`carousel/${location}`);
                const snapshot = await carouselRef.once('value');
                let nextOrder = 1;
                
                if (snapshot.exists()) {
                    const items = snapshot.val();
                    const orders = Object.values(items).map(item => item.order || 0);
                    nextOrder = Math.max(...orders) + 1;
                }

                // Save item data to Realtime Database
                const itemData = {
                    type,
                    title,
                    data: base64Data,
                    order: nextOrder,
                    fileType: file.type, // Aggiungiamo il tipo di file originale
                    updatedAt: new Date().toISOString()
                };

                if (itemId) {
                    // Update existing item
                    await carouselRef.child(itemId).update(itemData);
                } else {
                    // Add new item
                    await carouselRef.push(itemData);
                }

                closeCarouselItemModal();
                loadCarouselContent();
                showSuccess('Contenuto salvato con successo');
            } catch (error) {
                console.error('Error saving carousel item:', error);
                showError('Errore durante il salvataggio del contenuto: ' + error.message);
            }
        };

        window.deleteCarouselItem = async (location, itemId) => {
            if (confirm('Sei sicuro di voler eliminare questo contenuto?')) {
                try {
                    // Delete item from Database
                    await db.ref(`carousel/${location}/${itemId}`).remove();
                    loadCarouselContent();
                    showSuccess('Contenuto eliminato con successo');
                } catch (error) {
                    console.error('Error deleting carousel item:', error);
                    showError('Errore durante l\'eliminazione del contenuto');
                }
            }
        };

        window.loadCarouselContent = () => {
            const location = document.getElementById('carouselLocation').value;
            const itemsList = document.getElementById('carouselItemsList');
            
            db.ref(`carousel/${location}`).on('value', (snapshot) => {
                itemsList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    itemsList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-images"></i>
                            <p>Nessun contenuto trovato per questa sede</p>
                        </div>
                    `;
                    return;
                }

                // Convert to array and sort by order
                const items = [];
                snapshot.forEach((childSnapshot) => {
                    const item = childSnapshot.val();
                    item.id = childSnapshot.key;
                    items.push(item);
                });
                
                items.sort((a, b) => (a.order || 0) - (b.order || 0));

                items.forEach((item) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'carousel-item-card';
                    
                    const previewContent = item.type === 'image' 
                        ? `<img src="${item.data}" alt="${item.title}" class="carousel-item-preview">`
                        : `<video src="${item.data}" class="carousel-item-preview" muted></video>`;
                    
                    itemElement.innerHTML = `
                        ${previewContent}
                        <div class="carousel-item-info">
                            <div class="carousel-item-title">
                                <span class="item-number">${item.order}</span>
                                ${item.title}
                            </div>
                            <div class="carousel-item-type">
                                <i class="fas fa-${item.type === 'image' ? 'image' : 'video'}"></i>
                                ${item.type === 'image' ? 'Immagine' : 'Video'}
                            </div>
                        </div>
                        <div class="carousel-item-actions">
                            <button onclick="deleteCarouselItem('${location}', '${item.id}')" class="delete-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    itemsList.appendChild(itemElement);
                });
            });
        };

        // File preview
        document.getElementById('itemFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';
            
            console.log('File selezionato:', {
                nome: file.name,
                tipo: file.type,
                dimensione: file.size
            }); // Debug log

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                preview.appendChild(img);
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '200px';
                preview.appendChild(video);
            } else {
                preview.innerHTML = '<p>Tipo di file non supportato</p>';
            }
        });

        // Calendar functions
        window.editCalendar = () => {
            // Implement calendar editing interface
            showInfo('Funzionalità in sviluppo');
        };

        window.exportCalendar = async () => {
            try {
                const events = await exportCalendarData();
                downloadJSON(events, 'calendar.json');
                showSuccess('Calendario esportato con successo');
            } catch (error) {
                console.error('Error exporting calendar:', error);
                showError('Errore nell\'esportazione del calendario');
            }
        };

        // Substitutions functions
        let substitutionEntryCount = 1;

        window.addSubstitutionEntry = () => {
            const container = document.getElementById('substitutionsContainer');
            const newEntry = document.createElement('div');
            newEntry.className = 'substitution-entry';
            newEntry.innerHTML = `
                <div class="substitution-row">
                    <div class="form-group">
                        <label for="substitutionTimeSlot_${substitutionEntryCount}">Orario:</label>
                        <select id="substitutionTimeSlot_${substitutionEntryCount}" required>
                            <option value="1">1° ora (8:00-9:00)</option>
                            <option value="2">2° ora (9:00-10:00)</option>
                            <option value="3">3° ora (10:00-11:00)</option>
                            <option value="4">4° ora (11:00-12:00)</option>
                            <option value="5">5° ora (12:00-13:00)</option>
                            <option value="6">6° ora (13:00-14:00)</option>
                            <option value="7">7° ora (14:00-15:00)</option>
                            <option value="8">8° ora (15:00-16:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="substitutionClass_${substitutionEntryCount}">Classe:</label>
                        <input type="text" id="substitutionClass_${substitutionEntryCount}" required placeholder="es. 1A">
                    </div>
                    <div class="form-group">
                        <label for="replacedTeacher_${substitutionEntryCount}">Docente Sostituito:</label>
                        <input type="text" id="replacedTeacher_${substitutionEntryCount}" required>
                    </div>
                    <div class="form-group">
                        <label for="substituteTeacher_${substitutionEntryCount}">Docente Sostituto:</label>
                        <input type="text" id="substituteTeacher_${substitutionEntryCount}" required>
                    </div>
                    <button type="button" class="remove-substitution" onclick="removeSubstitutionEntry(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            container.appendChild(newEntry);
            substitutionEntryCount++;

            // Mostra il pulsante di rimozione sulla prima entry se ce ne sono più di una
            const entries = container.getElementsByClassName('substitution-entry');
            if (entries.length > 1) {
                entries[0].querySelector('.remove-substitution').style.display = 'flex';
            }
        };

        window.removeSubstitutionEntry = (button) => {
            const entry = button.closest('.substitution-entry');
            entry.remove();

            // Nascondi il pulsante di rimozione sulla prima entry se rimane solo una
            const container = document.getElementById('substitutionsContainer');
            const entries = container.getElementsByClassName('substitution-entry');
            if (entries.length === 1) {
                entries[0].querySelector('.remove-substitution').style.display = 'none';
            }
        };

        window.addSubstitution = () => {
            const modal = document.getElementById('substitutionModal');
            const form = document.getElementById('substitutionForm');
            const today = new Date().toISOString().split('T')[0];
            
            // Reset del form
            form.reset();
            document.getElementById('substitutionDate').value = today;
            document.getElementById('substitutionLocation').value = 'TO1';
            
            // Reset del container delle sostituzioni
            const container = document.getElementById('substitutionsContainer');
            container.innerHTML = `
                <div class="substitution-entry">
                    <div class="substitution-row">
                        <div class="form-group">
                            <label for="substitutionTimeSlot_0">Orario:</label>
                            <select id="substitutionTimeSlot_0" required>
                                <option value="1">1° ora (8:00-9:00)</option>
                                <option value="2">2° ora (9:00-10:00)</option>
                                <option value="3">3° ora (10:00-11:00)</option>
                                <option value="4">4° ora (11:00-12:00)</option>
                                <option value="5">5° ora (12:00-13:00)</option>
                                <option value="6">6° ora (13:00-14:00)</option>
                                <option value="7">7° ora (14:00-15:00)</option>
                                <option value="8">8° ora (15:00-16:00)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="substitutionClass_0">Classe:</label>
                            <input type="text" id="substitutionClass_0" required placeholder="es. 1A">
                        </div>
                        <div class="form-group">
                            <label for="replacedTeacher_0">Docente Sostituito:</label>
                            <input type="text" id="replacedTeacher_0" required>
                        </div>
                        <div class="form-group">
                            <label for="substituteTeacher_0">Docente Sostituto:</label>
                            <input type="text" id="substituteTeacher_0" required>
                        </div>
                        <button type="button" class="remove-substitution" onclick="removeSubstitutionEntry(this)" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            substitutionEntryCount = 1;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            modal.style.display = 'block';
            modal.classList.add('active');
        };

        // Funzione per chiudere il modal delle sostituzioni
        window.closeSubstitutionModal = function() {
                    const modal = document.getElementById('substitutionModal');
            modal.style.display = 'none';
            modal.classList.remove('active');
            // Rimuovi eventuale stato di modifica
            const form = document.getElementById('substitutionForm');
            if (form) form.removeAttribute('data-edit-id');
        };

        window.handleSubstitutionSubmit = async (event) => {
            event.preventDefault();
            
            const date = document.getElementById('substitutionDate').value;
            const location = document.getElementById('substitutionLocation').value;
            const substitutions = [];
            
            // Raccogli tutte le sostituzioni dal form
            const entries = document.getElementsByClassName('substitution-entry');
            for (let i = 0; i < entries.length; i++) {
                const timeSlot = document.getElementById(`substitutionTimeSlot_${i}`).value;
                const class_ = document.getElementById(`substitutionClass_${i}`).value;
                const replacedTeacher = document.getElementById(`replacedTeacher_${i}`).value;
                const substituteTeacher = document.getElementById(`substituteTeacher_${i}`).value;
                
                substitutions.push({
                    date,
                    location,
                    timeSlot,
                    class: class_,
                    replacedTeacher,
                    substituteTeacher,
                updatedAt: new Date().toISOString()
                });
            }

            try {
                // Salva tutte le sostituzioni
                const promises = substitutions.map(substitution => 
                    db.ref('substitutions').push(substitution)
                );
                await Promise.all(promises);
                
                // Mostra il messaggio di successo
                const successMessage = document.createElement('div');
                successMessage.className = 'success-message';
                successMessage.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <p>${substitutions.length} sostituzione${substitutions.length > 1 ? 'i' : ''} salvata${substitutions.length > 1 ? 'e' : ''} con successo!</p>
                `;
                document.body.appendChild(successMessage);

                // Rimuovi il messaggio dopo 3 secondi
                setTimeout(() => {
                    successMessage.style.animation = 'slideOut 0.3s ease-out forwards';
                    setTimeout(() => successMessage.remove(), 300);
                }, 3000);

                // Chiudi il modale e ricarica le sostituzioni
                closeSubstitutionModal();
                loadSubstitutions();
            } catch (error) {
                console.error('Error saving substitutions:', error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'error-message';
                errorMessage.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Errore durante il salvataggio delle sostituzioni</p>
                `;
                document.body.appendChild(errorMessage);

                // Rimuovi il messaggio di errore dopo 3 secondi
                setTimeout(() => {
                    errorMessage.style.animation = 'slideOut 0.3s ease-out forwards';
                    setTimeout(() => errorMessage.remove(), 300);
                }, 3000);
            }
        };

        // Function to filter substitutions in admin panel
        window.filterAdminSubstitutions = () => {
            const selectedLocation = document.getElementById('adminLocationFilter').value;
            const selectedDate = document.getElementById('adminDateFilter').value;
            loadSubstitutions(selectedLocation, selectedDate);
        };

        // Function to load and display substitutions with filters
        function loadSubstitutions(location = 'all', date = '') {
            console.log('Loading substitutions with filters:', { location, date }); // Debug log
            const substitutionsRef = db.ref('substitutions');
            const substitutionsQuery = substitutionsRef.orderByChild('date');

            substitutionsQuery.on('value', (snapshot) => {
                console.log('Snapshot received:', snapshot.exists()); // Debug log
                const substitutionsList = document.getElementById('substitutionsList');
                substitutionsList.innerHTML = '';

                const substitutions = [];
                snapshot.forEach((childSnapshot) => {
                    const substitution = childSnapshot.val();
                    console.log('Processing substitution:', substitution); // Debug log
                    // Apply filters
                    if ((location === 'all' || substitution.location === location) &&
                        (!date || substitution.date === date)) {
                        substitution.id = childSnapshot.key;
                        substitutions.push(substitution);
                    }
                });

                console.log('Filtered substitutions:', substitutions); // Debug log

                if (substitutions.length === 0) {
                    substitutionsList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-calendar-check"></i>
                            <p>Nessuna sostituzione trovata con i filtri selezionati</p>
                        </div>
                    `;
                    return;
                }

                // Sort substitutions by date and time slot
                substitutions.sort((a, b) => {
                    if (a.date === b.date) {
                        return parseInt(a.timeSlot) - parseInt(b.timeSlot);
                    }
                    return a.date.localeCompare(b.date);
                });

                // Group substitutions by date
                const groupedSubstitutions = substitutions.reduce((groups, substitution) => {
                    const date = substitution.date;
                    if (!groups[date]) {
                        groups[date] = [];
                    }
                    groups[date].push(substitution);
                    return groups;
                }, {});

                // Create HTML for each date group
                Object.entries(groupedSubstitutions).forEach(([date, dateSubstitutions]) => {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'date-group-header';
                    dateHeader.innerHTML = `
                        <h3>${new Date(date).toLocaleDateString('it-IT', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</h3>
                    `;
                    substitutionsList.appendChild(dateHeader);

                    dateSubstitutions.forEach(substitution => {
                        const substitutionElement = document.createElement('div');
                        substitutionElement.className = 'substitution-item';
                        substitutionElement.innerHTML = `
                            <div class="substitution-info">
                                <div class="substitution-header">
                                    <span class="location">${substitution.location}</span>
                                    <span class="time">${getTimeSlotText(substitution.timeSlot)}</span>
                                </div>
                                <div class="substitution-details">
                                    <span class="class">Classe: ${substitution.class}</span>
                                    <span class="teachers">
                                        <span class="replaced">Sostituito: ${substitution.replacedTeacher}</span>
                                        <span class="substitute">Sostituto: ${substitution.substituteTeacher}</span>
                                    </span>
                                </div>
                            </div>
                            <div class="substitution-actions">
                                <button onclick="editSubstitution('${substitution.id}')" class="edit-button">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteSubstitution('${substitution.id}')" class="delete-button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        substitutionsList.appendChild(substitutionElement);
                    });
                });
            }, (error) => {
                console.error('Error loading substitutions:', error);
                const substitutionsList = document.getElementById('substitutionsList');
                substitutionsList.innerHTML = `
                    <div class="no-data error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Errore nel caricamento delle sostituzioni</p>
                    </div>
                `;
            });
        }

        // Function to get time slot text
        function getTimeSlotText(slot) {
            const timeSlots = {
                1: "8:00-9:00",
                2: "9:00-10:00",
                3: "10:00-11:00",
                4: "11:00-12:00",
                5: "12:00-13:00",
                6: "13:00-14:00",
                7: "14:00-15:00",
                8: "15:00-16:00"
            };
            return timeSlots[slot] || `Ora ${slot}`;
        }

        // Initialize filters and load substitutions when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const adminDateFilter = document.getElementById('adminDateFilter');
            if (adminDateFilter) {
                adminDateFilter.value = today;
                loadSubstitutions('all', today);
            }
        });

        // Load substitutions when admin panel is shown
        auth.onAuthStateChanged((user) => {
            if (user) {
                const today = new Date().toISOString().split('T')[0];
                loadSubstitutions('all', today);
            }
        });

        // Organizational structure functions
        async function populateParentSelect(currentNodeId = null) {
            const parentSelect = document.getElementById('parentId');
            parentSelect.innerHTML = '<option value="">(Nessun genitore - nodo radice)</option>';
            try {
                const snapshot = await db.ref('orgStructure').once('value');
                snapshot.forEach(childSnapshot => {
                    const node = childSnapshot.val();
                    const nodeId = childSnapshot.key;
                    if (nodeId !== currentNodeId) {
                        const option = document.createElement('option');
                        option.value = nodeId;
                        option.textContent = node.title + (node.name ? ' - ' + node.name : '');
                        parentSelect.appendChild(option);
                    }
                });
            } catch (e) {
                // fallback: solo opzione radice
            }
        }

        window.addOrgNode = async (parentId = null) => {
            const modal = document.getElementById('orgNodeModal');
            document.getElementById('nodeId').value = '';
            await populateParentSelect();
            document.getElementById('parentId').value = parentId || '';
            document.getElementById('nodeTitle').value = '';
            document.getElementById('nodeName').value = '';
            document.getElementById('nodeRole').value = '';
            document.getElementById('nodeDescription').value = '';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            modal.style.display = 'block';
            modal.classList.add('active');
        };

        window.editOrgNode = (nodeId) => {
            const nodeRef = db.ref(`orgStructure/${nodeId}`);
            nodeRef.once('value').then(async (snapshot) => {
                if (snapshot.exists()) {
                    const node = snapshot.val();
                    const modal = document.getElementById('orgNodeModal');
                    document.getElementById('nodeId').value = nodeId;
                    await populateParentSelect(nodeId);
                    document.getElementById('parentId').value = node.parentId || '';
                    document.getElementById('nodeTitle').value = node.title || '';
                    document.getElementById('nodeName').value = node.name || '';
                    document.getElementById('nodeRole').value = node.role || '';
                    document.getElementById('nodeDescription').value = node.description || '';
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    modal.style.display = 'block';
                    modal.classList.add('active');
                }
            });
        };

        window.closeOrgNodeModal = () => {
            document.getElementById('orgNodeModal').style.display = 'none';
        };

        window.handleOrgNodeSubmit = async (event) => {
            event.preventDefault();
            
            const nodeId = document.getElementById('nodeId').value;
            const nodeData = {
                parentId: document.getElementById('parentId').value || null,
                title: document.getElementById('nodeTitle').value,
                name: document.getElementById('nodeName').value,
                role: document.getElementById('nodeRole').value,
                description: document.getElementById('nodeDescription').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (nodeId) {
                    await db.ref(`orgStructure/${nodeId}`).update(nodeData);
                } else {
                    await db.ref('orgStructure').push(nodeData);
                }
                closeOrgNodeModal();
                loadOrgStructure();
                showSuccess('Nodo salvato con successo');
            } catch (error) {
                console.error('Error saving org node:', error);
                showError('Errore durante il salvataggio del nodo');
            }
        };

        window.deleteOrgNode = async (nodeId) => {
            if (confirm('Sei sicuro di voler eliminare questo nodo? Verranno eliminati anche tutti i nodi figli.')) {
                try {
                    // Prima elimina tutti i nodi figli
                    const deleteChildren = async (parentId) => {
                        const snapshot = await db.ref('orgStructure').orderByChild('parentId').equalTo(parentId).once('value');
                        const promises = [];
                        snapshot.forEach((childSnapshot) => {
                            promises.push(deleteChildren(childSnapshot.key));
                            promises.push(db.ref(`orgStructure/${childSnapshot.key}`).remove());
                        });
                        await Promise.all(promises);
                    };

                    await deleteChildren(nodeId);
                    await db.ref(`orgStructure/${nodeId}`).remove();
                    loadOrgStructure();
                    showSuccess('Nodo eliminato con successo');
            } catch (error) {
                    console.error('Error deleting org node:', error);
                    showError('Errore durante l\'eliminazione del nodo');
                }
            }
        };

        window.loadOrgStructure = async () => {
            const orgTree = document.getElementById('orgTree');
            orgTree.innerHTML = '';

            try {
                const snapshot = await db.ref('orgStructure').once('value');
                if (!snapshot.exists()) {
                    orgTree.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-sitemap"></i>
                            <p>Nessun nodo presente nell'organigramma</p>
                            <button onclick="addOrgNode()" class="admin-button-small">
                                <i class="fas fa-plus"></i> Aggiungi Primo Nodo
                            </button>
                        </div>
                    `;
                    return;
                }

                // Converti i dati in una struttura ad albero
                const nodes = [];
                const nodeMap = new Map();

                snapshot.forEach((childSnapshot) => {
                    const node = childSnapshot.val();
                    node.id = childSnapshot.key;
                    nodes.push(node);
                    nodeMap.set(node.id, node);
                });

                // Organizza i nodi in una struttura ad albero
                const rootNodes = nodes.filter(node => !node.parentId);
                const buildTree = (parentNode) => {
                    const children = nodes.filter(node => node.parentId === parentNode.id);
                    return {
                        ...parentNode,
                        children: children.map(child => buildTree(child))
                    };
                };

                const tree = rootNodes.map(node => buildTree(node));

                // Funzione per renderizzare l'albero
                const renderNode = (node, level = 0) => {
                    const nodeElement = document.createElement('div');
                    nodeElement.className = 'org-node';
                    
                    const nodeContent = document.createElement('div');
                    nodeContent.className = 'org-node-content';
                    nodeContent.innerHTML = `
                        <div class="org-node-header">
                            <h3>${node.title}</h3>
                            <div class="org-node-actions">
                                <button onclick="addOrgNode('${node.id}')" class="edit-button" title="Aggiungi figlio">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button onclick="editOrgNode('${node.id}')" class="edit-button" title="Modifica">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteOrgNode('${node.id}')" class="delete-button" title="Elimina">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="org-node-details">
                            <p class="name">${node.name}</p>
                            <p class="role">${node.role}</p>
                            ${node.description ? `<p class="description">${node.description}</p>` : ''}
                        </div>
                    `;
                    nodeElement.appendChild(nodeContent);

                    if (node.children && node.children.length > 0) {
                        const childrenContainer = document.createElement('div');
                        childrenContainer.className = 'org-node-children';
                        
                        // Aggiungi la linea di collegamento verticale
                        const verticalLine = document.createElement('div');
                        verticalLine.className = 'vertical-line';
                        childrenContainer.appendChild(verticalLine);

                        // Aggiungi i nodi figli
                        node.children.forEach((child, index) => {
                            const childNode = renderNode(child, level + 1);
                            
                            // Aggiungi la linea orizzontale tra i nodi fratelli
                            if (index < node.children.length - 1) {
                                const horizontalLine = document.createElement('div');
                                horizontalLine.className = 'horizontal-line';
                                childrenContainer.appendChild(horizontalLine);
                            }
                            
                            childrenContainer.appendChild(childNode);
                        });
                        
                        nodeElement.appendChild(childrenContainer);
                    }

                    return nodeElement;
                };

                // Aggiungi gli stili CSS per l'organigramma
                const orgStyles = document.createElement('style');
                orgStyles.textContent = `
                    .org-structure-editor {
                        padding: 2rem;
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 8px;
                        min-height: 200px;
                        overflow: auto;
                    }

                    .org-tree {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        padding: 2rem 0;
                    }

                    .org-node {
                        position: relative;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        margin: 1rem 0;
                    }

                    .org-node-content {
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 8px;
                        padding: 1.5rem;
                        min-width: 250px;
                        position: relative;
                        z-index: 2;
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    }

                    .org-node-content:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
                        background: rgba(255, 255, 255, 0.15);
                    }

                    .org-node-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 1rem;
                    }

                    .org-node-header h3 {
                        margin: 0;
                        color: var(--primary-color);
                        font-size: 1.2rem;
                    }

                    .org-node-actions {
                        display: flex;
                        gap: 0.5rem;
                    }

                    .org-node-details {
                        text-align: left;
                    }

                    .org-node-details .name {
                        font-weight: 600;
                        margin: 0.5rem 0;
                        font-size: 1.1rem;
                    }

                    .org-node-details .role {
                        color: var(--primary-color);
                        margin: 0.5rem 0;
                        font-weight: 500;
                    }

                    .org-node-details .description {
                        color: rgba(255, 255, 255, 0.7);
                        margin: 0.5rem 0;
                        font-size: 0.9rem;
                        line-height: 1.4;
                    }

                    .org-node-children {
                        display: flex;
                        justify-content: center;
                        position: relative;
                        margin-top: 2rem;
                        padding-top: 2rem;
                        min-width: 100%;
                    }

                    .vertical-line {
                        position: absolute;
                        top: 0;
                        left: 50%;
                        width: 2px;
                        height: 2rem;
                        background: rgba(255, 255, 255, 0.2);
                        transform: translateX(-50%);
                    }

                    .horizontal-line {
                        position: absolute;
                        top: -2rem;
                        width: 100%;
                        height: 2px;
                        background: rgba(255, 255, 255, 0.2);
                    }

                    .org-node-children .org-node {
                        position: relative;
                        margin: 0 2rem;
                    }

                    .org-node-children .org-node:not(:last-child)::after {
                        content: '';
                        position: absolute;
                        top: -2rem;
                        right: -2rem;
                        width: 4rem;
                        height: 2px;
                        background: rgba(255, 255, 255, 0.2);
                    }

                    @media screen and (max-width: 768px) {
                        .org-structure-editor {
                            padding: 1rem;
                        }

                        .org-node-content {
                            min-width: 200px;
                            padding: 1rem;
                        }

                        .org-node-children {
                            flex-direction: column;
                            align-items: center;
                        }

                        .org-node-children .org-node {
                            margin: 1rem 0;
                        }

                        .org-node-children .org-node:not(:last-child)::after {
                            display: none;
                        }

                        .horizontal-line {
                            display: none;
                        }
                    }
                `;
                document.head.appendChild(orgStyles);

                // Renderizza l'albero
                tree.forEach(node => {
                    orgTree.appendChild(renderNode(node));
                });

            } catch (error) {
                console.error('Error loading org structure:', error);
                orgTree.innerHTML = `
                    <div class="no-data error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Errore nel caricamento dell'organigramma</p>
                    </div>
                `;
            }
        };

        // Carica l'organigramma quando il pannello admin è mostrato
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadOrgStructure();
            }
        });

        // Calendar Event Functions
        window.addCalendarEvent = () => {
            const modal = document.getElementById('calendarEventModal');
            const form = document.getElementById('calendarEventForm');
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('eventId').value = '';
            document.getElementById('eventDate').value = today;
            document.getElementById('eventLocation').value = 'all';
            document.getElementById('eventTimeSlot').value = '1';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            modal.style.display = 'block';
            modal.classList.add('active');
        };

        window.editCalendarEvent = (eventId) => {
            const eventRef = db.ref(`calendar/${eventId}`);
            eventRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const event = snapshot.val();
                    const modal = document.getElementById('calendarEventModal');
                    
                    document.getElementById('eventId').value = eventId;
                    document.getElementById('eventDate').value = event.date;
                    document.getElementById('eventLocation').value = event.location;
                    document.getElementById('eventTimeSlot').value = event.timeSlot;
                    document.getElementById('eventTitle').value = event.title;
                    document.getElementById('eventDescription').value = event.description || '';
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    modal.style.display = 'block';
                    modal.classList.add('active');
                }
            });
        };

        window.closeCalendarEventModal = () => {
            document.getElementById('calendarEventModal').style.display = 'none';
        };

        window.handleCalendarEventSubmit = async (event) => {
            event.preventDefault();
            
            const eventId = document.getElementById('eventId').value;
            const calendarEvent = {
                date: document.getElementById('eventDate').value,
                location: document.getElementById('eventLocation').value,
                timeSlot: document.getElementById('eventTimeSlot').value,
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (eventId) {
                    await db.ref(`calendar/${eventId}/date`).set(calendarEvent.date);
                    await db.ref(`calendar/${eventId}/location`).set(calendarEvent.location);
                    await db.ref(`calendar/${eventId}/timeSlot`).set(calendarEvent.timeSlot);
                    await db.ref(`calendar/${eventId}/title`).set(calendarEvent.title);
                    await db.ref(`calendar/${eventId}/description`).set(calendarEvent.description);
                    await db.ref(`calendar/${eventId}/updatedAt`).set(calendarEvent.updatedAt);
                } else {
                    await db.ref('calendar').push(calendarEvent);
                }
                closeCalendarEventModal();
                loadCalendarEvents();
            } catch (error) {
                console.error('Error saving calendar event:', error);
                alert('Errore durante il salvataggio dell\'evento');
            }
        };

        window.deleteCalendarEvent = async (eventId) => {
            if (confirm('Sei sicuro di voler eliminare questo evento?')) {
                try {
                    await db.ref(`calendar/${eventId}`).remove();
                    loadCalendarEvents();
                } catch (error) {
                    console.error('Error deleting calendar event:', error);
                    alert('Errore durante l\'eliminazione dell\'evento');
                }
            }
        };

        window.filterCalendarEvents = () => {
            const selectedLocation = document.getElementById('calendarLocationFilter').value;
            const selectedDate = document.getElementById('calendarDateFilter').value;
            loadCalendarEvents(selectedLocation, selectedDate);
        };

        function loadCalendarEvents(location = 'all', date = '') {
            console.log('Loading calendar events with filters:', { location, date });
            const eventsRef = db.ref('calendar');
            const eventsQuery = eventsRef.orderByChild('date');

            eventsQuery.on('value', (snapshot) => {
                console.log('Calendar snapshot received:', snapshot.exists());
                const eventsList = document.getElementById('calendarEventsList');
                eventsList.innerHTML = '';

                const events = [];
                snapshot.forEach((childSnapshot) => {
                    const event = childSnapshot.val();
                    console.log('Processing event:', event);
                    if ((location === 'all' || event.location === location) &&
                        (!date || event.date === date)) {
                        event.id = childSnapshot.key;
                        events.push(event);
                    }
                });

                console.log('Filtered events:', events);

                if (events.length === 0) {
                    eventsList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-calendar-check"></i>
                            <p>Nessun evento trovato con i filtri selezionati</p>
                        </div>
                    `;
                    return;
                }

                // Sort events by date and time slot
                events.sort((a, b) => {
                    if (a.date === b.date) {
                        return parseInt(a.timeSlot) - parseInt(b.timeSlot);
                    }
                    return a.date.localeCompare(b.date);
                });

                // Group events by date
                const groupedEvents = events.reduce((groups, event) => {
                    const date = event.date;
                    if (!groups[date]) {
                        groups[date] = [];
                    }
                    groups[date].push(event);
                    return groups;
                }, {});

                // Create HTML for each date group
                Object.entries(groupedEvents).forEach(([date, dateEvents]) => {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'date-group-header';
                    dateHeader.innerHTML = `
                        <h3>${new Date(date).toLocaleDateString('it-IT', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</h3>
                    `;
                    eventsList.appendChild(dateHeader);

                    dateEvents.forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'substitution-item';
                        eventElement.innerHTML = `
                            <div class="substitution-info">
                                <div class="substitution-header">
                                    <span class="location">${event.location === 'all' ? 'Tutte le Sedi' : event.location}</span>
                                    <span class="time">${getTimeSlotText(event.timeSlot)}</span>
                                </div>
                                <div class="substitution-details">
                                    <span class="title">${event.title}</span>
                                    ${event.description ? `<span class="description">${event.description}</span>` : ''}
                                </div>
                            </div>
                            <div class="substitution-actions">
                                <button onclick="editCalendarEvent('${event.id}')" class="edit-button">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteCalendarEvent('${event.id}')" class="delete-button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        eventsList.appendChild(eventElement);
                    });
                });
            }, (error) => {
                console.error('Error loading calendar events:', error);
                const eventsList = document.getElementById('calendarEventsList');
                eventsList.innerHTML = `
                    <div class="no-data error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Errore nel caricamento degli eventi</p>
                    </div>
                `;
            });
        }

        // Initialize calendar filters and load events when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const calendarDateFilter = document.getElementById('calendarDateFilter');
            if (calendarDateFilter) {
                calendarDateFilter.value = today;
                loadCalendarEvents('all', today);
            }
        });

        // Load calendar events when admin panel is shown
        auth.onAuthStateChanged((user) => {
            if (user) {
                const today = new Date().toISOString().split('T')[0];
                loadCalendarEvents('all', today);
            }
        });

        // Ripristino funzioni per modifica e cancellazione singola sostituzione
        window.editSubstitution = async function(id) {
            // Recupera la sostituzione dal database
            const ref = db.ref('substitutions/' + id);
            const snapshot = await ref.once('value');
            if (!snapshot.exists()) return;
            const s = snapshot.val();

            // Prepara il form per la modifica di una sola sostituzione
            const modal = document.getElementById('substitutionModal');
            const form = document.getElementById('substitutionForm');
            form.reset();
            document.getElementById('substitutionDate').value = s.date;
            document.getElementById('substitutionLocation').value = s.location;
            
            // Popola il container con una sola entry
            const container = document.getElementById('substitutionsContainer');
            container.innerHTML = `
                <div class="substitution-entry">
                    <div class="substitution-row">
                        <div class="form-group">
                            <label for="substitutionTimeSlot_0">Orario:</label>
                            <select id="substitutionTimeSlot_0" required>
                                <option value="1">1° ora (8:00-9:00)</option>
                                <option value="2">2° ora (9:00-10:00)</option>
                                <option value="3">3° ora (10:00-11:00)</option>
                                <option value="4">4° ora (11:00-12:00)</option>
                                <option value="5">5° ora (12:00-13:00)</option>
                                <option value="6">6° ora (13:00-14:00)</option>
                                <option value="7">7° ora (14:00-15:00)</option>
                                <option value="8">8° ora (15:00-16:00)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="substitutionClass_0">Classe:</label>
                            <input type="text" id="substitutionClass_0" required placeholder="es. 1A">
                        </div>
                        <div class="form-group">
                            <label for="replacedTeacher_0">Docente Sostituito:</label>
                            <input type="text" id="replacedTeacher_0" required>
                        </div>
                        <div class="form-group">
                            <label for="substituteTeacher_0">Docente Sostituto:</label>
                            <input type="text" id="substituteTeacher_0" required>
                        </div>
                        <button type="button" class="remove-substitution" onclick="removeSubstitutionEntry(this)" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            // Imposta i valori
            document.getElementById('substitutionTimeSlot_0').value = s.timeSlot;
            document.getElementById('substitutionClass_0').value = s.class;
            document.getElementById('replacedTeacher_0').value = s.replacedTeacher;
            document.getElementById('substituteTeacher_0').value = s.substituteTeacher;

            // Salva l'id della sostituzione in modifica
            form.setAttribute('data-edit-id', id);

            window.scrollTo({ top: 0, behavior: 'smooth' });
            modal.style.display = 'block';
            modal.classList.add('active');
        };

        window.deleteSubstitution = async function(id) {
            if (!confirm('Sei sicuro di voler eliminare questa sostituzione?')) return;
            try {
                await db.ref('substitutions/' + id).remove();
                loadSubstitutions();
                // Mostra messaggio di successo
                const successMessage = document.createElement('div');
                successMessage.className = 'success-message';
                successMessage.innerHTML = `
                    <i class=\"fas fa-check-circle\"></i>
                    <p>Sostituzione eliminata con successo!</p>
                `;
                document.body.appendChild(successMessage);
                setTimeout(() => {
                    successMessage.style.animation = 'slideOut 0.3s ease-out forwards';
                    setTimeout(() => successMessage.remove(), 300);
                }, 3000);
            } catch (error) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'error-message';
                errorMessage.innerHTML = `
                    <i class=\"fas fa-exclamation-circle\"></i>
                    <p>Errore durante l'eliminazione della sostituzione</p>
                `;
                document.body.appendChild(errorMessage);
                setTimeout(() => {
                    errorMessage.style.animation = 'slideOut 0.3s ease-out forwards';
                    setTimeout(() => errorMessage.remove(), 300);
                }, 3000);
            }
        };

        // Modifica la funzione handleSubstitutionSubmit per gestire anche l'update
        const originalHandleSubstitutionSubmit = window.handleSubstitutionSubmit;
        window.handleSubstitutionSubmit = async function(event) {
            event.preventDefault();
            const form = document.getElementById('substitutionForm');
            const editId = form.getAttribute('data-edit-id');
            if (editId) {
                // Modifica singola sostituzione
                const date = document.getElementById('substitutionDate').value;
                const location = document.getElementById('substitutionLocation').value;
                const timeSlot = document.getElementById('substitutionTimeSlot_0').value;
                const class_ = document.getElementById('substitutionClass_0').value;
                const replacedTeacher = document.getElementById('replacedTeacher_0').value;
                const substituteTeacher = document.getElementById('substituteTeacher_0').value;
                try {
                    await db.ref('substitutions/' + editId).update({
                        date,
                        location,
                        timeSlot,
                        class: class_,
                        replacedTeacher,
                        substituteTeacher,
                        updatedAt: new Date().toISOString()
                    });
                    form.removeAttribute('data-edit-id');
                    closeSubstitutionModal();
                    loadSubstitutions();
                    // Messaggio di successo
                    const successMessage = document.createElement('div');
                    successMessage.className = 'success-message';
                    successMessage.innerHTML = `
                        <i class=\"fas fa-check-circle\"></i>
                        <p>Sostituzione modificata con successo!</p>
                    `;
                    document.body.appendChild(successMessage);
                    setTimeout(() => {
                        successMessage.style.animation = 'slideOut 0.3s ease-out forwards';
                        setTimeout(() => successMessage.remove(), 300);
                    }, 3000);
                } catch (error) {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'error-message';
                    errorMessage.innerHTML = `
                        <i class=\"fas fa-exclamation-circle\"></i>
                        <p>Errore durante la modifica della sostituzione</p>
                    `;
                    document.body.appendChild(errorMessage);
                    setTimeout(() => {
                        errorMessage.style.animation = 'slideOut 0.3s ease-out forwards';
                        setTimeout(() => errorMessage.remove(), 300);
                    }, 3000);
                }
            } else {
                // Inserimento batch
                await originalHandleSubstitutionSubmit(event);
            }
        };
    </script>

    <style>
        .admin-panel {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .modal {
            display: none;  /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;  /* Show as flex when active */
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            position: relative;
            width: 90%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            margin: 2rem auto;
        }

        .admin-section {
            margin: 2rem 0;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .admin-button-small {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .admin-button-small:hover {
            background: var(--primary-color-dark);
            transform: translateY(-2px);
        }

        .admin-button-small i {
            font-size: 1.2rem;
        }

        .login-prompt {
            text-align: center;
            padding: 3rem;
            margin: 2rem auto;
            max-width: 400px;
        }

        .login-prompt i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .admin-header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-user {
            color: #fff;
            font-size: 0.9rem;
        }

        /* Substitutions List Styles */
        .substitutions-list {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .substitution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .substitution-info {
            flex: 1;
        }

        .substitution-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .substitution-header .location {
            color: var(--primary-color);
            font-weight: 600;
        }

        .substitution-details {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .substitution-actions {
            display: flex;
            gap: 0.5rem;
        }

        .edit-button,
        .delete-button {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .edit-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary-color);
        }

        .delete-button {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }

        .edit-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .delete-button:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .location-filter,
        .date-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 200px;
        }

        .location-filter select,
        .date-filter input {
            padding: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            flex: 1;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .date-group-header {
            margin: 1.5rem 0 0.5rem 0;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .date-group-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--text-color);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .no-data i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        @media screen and (max-width: 768px) {
            .filters {
                flex-direction: column;
            }

            .location-filter,
            .date-filter {
                width: 100%;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .admin-button-small {
                width: 100%;
            }
        }

        .no-data.error {
            color: #ff6b6b;
        }

        .no-data.error i {
            color: #ff6b6b;
        }

        .events-list {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .event-info {
            flex: 1;
        }

        .event-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .event-header .location {
            color: var(--primary-color);
            font-weight: 600;
        }

        .event-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .event-details .title {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .event-details .description {
            margin: 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .event-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        @media screen and (max-width: 768px) {
            .event-item {
                flex-direction: column;
                gap: 1rem;
            }

            .event-header {
                flex-direction: column;
                gap: 0.25rem;
            }

            .event-actions {
                width: 100%;
                justify-content: flex-end;
                margin-left: 0;
            }
        }

        .carousel-items-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .carousel-item-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            position: relative;
        }

        .carousel-item-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .carousel-item-info {
            margin-bottom: 10px;
        }

        .carousel-item-title {
            display: flex;
            align-items: center;
        }

        .item-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            margin-right: 8px;
            font-size: 0.9em;
        }

        .carousel-item-type {
            font-size: 0.9em;
            color: var(--primary-color);
        }

        .carousel-item-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .file-preview {
            margin-top: 10px;
            max-width: 300px;
            max-height: 200px;
            overflow: hidden;
            border-radius: 5px;
        }

        .file-preview img,
        .file-preview video {
            width: 100%;
            height: auto;
            object-fit: cover;
        }

        .location-selector {
            margin-bottom: 20px;
        }

        .location-selector select {
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-content select,
        .modal-content input[type="text"],
        .modal-content input[type="date"],
        .modal-content textarea {
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .modal-content select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 15px;
            padding-right: 45px;
            cursor: pointer;
        }

        .modal-content select:hover,
        .modal-content input[type="text"]:hover,
        .modal-content input[type="date"]:hover,
        .modal-content textarea:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .modal-content select:focus,
        .modal-content input[type="text"]:focus,
        .modal-content input[type="date"]:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3);
        }

        .modal-content .form-group {
            margin-bottom: 1.5rem;
        }

        .modal-content .form-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .modal-content .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }

        .modal-content .save-button,
        .modal-content .cancel-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .modal-content .save-button {
            background: var(--primary-color);
            color: #000;
            font-weight: 600;
        }

        .modal-content .save-button:hover {
            background: var(--primary-color-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.4);
        }

        .modal-content .cancel-button {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .modal-content .cancel-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .modal-content .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.9);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .modal-content .close-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        /* Variabili CSS per i colori primari */
        :root {
            --primary-color: #ffd700;
            --primary-color-dark: #e6c200;
            --primary-color-rgb: 255, 215, 0;
        }

        .substitution-entry {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .substitution-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: start;
        }

        .remove-substitution {
            background: rgba(255, 107, 107, 0.1);
            border: none;
            color: #ff6b6b;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 32px;
        }

        .remove-substitution:hover {
            background: rgba(255, 107, 107, 0.2);
            transform: rotate(90deg);
        }

        .add-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary-color);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        @media screen and (max-width: 1200px) {
            .substitution-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media screen and (max-width: 768px) {
            .substitution-row {
                grid-template-columns: 1fr;
            }
        }

        /* Message styles */
        .success-message,
        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .success-message {
            background: rgba(46, 213, 115, 0.9);
            color: #fff;
            border: 1px solid rgba(46, 213, 115, 0.2);
        }

        .error-message {
            background: rgba(255, 71, 87, 0.9);
            color: #fff;
            border: 1px solid rgba(255, 71, 87, 0.2);
        }

        .success-message i,
        .error-message i {
            font-size: 1.2rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .modal-content select,
        .modal-content select option {
            background: #222;
            color: #fff;
        }
    </style>
</body>
</html> 