<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Totem</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
    <div class="container glass-effect">
        <div class="header">
            <a href="index.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
                <span>Torna alla Home</span>
            </a>
            <div class="logo-container">
                <img src="https://www.istitutoboselli.edu.it/wp-content/uploads/2024/04/logo-boselli-ritaglio-1.png" alt="Logo IIS P.Boselli" class="school-logo">
            </div>
            <div class="admin-header-controls">
                <span id="adminUser" class="admin-user"></span>
                <button onclick="handleLogout()" class="admin-button-small">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
            <i class="fas fa-cog music-icon"></i>
            <h1>Admin Panel</h1>
            <div class="subtitle">Gestione Sistema Totem</div>
        </div>

        <div id="adminContent" class="admin-panel" style="display: none;">
            <!-- Carousel Management Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-images"></i> Gestione Carosello</h2>
                <div class="admin-controls">
                    <div class="filters-container">
                        <div class="location-selector">
                            <label for="carouselLocation">Seleziona Sede:</label>
                            <select id="carouselLocation" onchange="loadCarouselContent()">
                                <option value="viasansovino">Via Sansovino</option>
                                <option value="vialuini">Via Luini</option>
                            </select>
                        </div>
                        <div class="content-filters">
                            <div class="filter-group">
                                <label for="contentTypeFilter">Tipo Contenuto:</label>
                                <select id="contentTypeFilter" onchange="filterCarouselContent()">
                                    <option value="all">Tutti</option>
                                    <option value="image">Immagini</option>
                                    <option value="video">Video</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="sortOrder">Ordina per:</label>
                                <select id="sortOrder" onchange="filterCarouselContent()">
                                    <option value="order">Numero d'ordine</option>
                                    <option value="date">Data di caricamento</option>
                                    <option value="title">Titolo</option>
                                </select>
                            </div>
                            <div class="search-group">
                                <input type="text" id="contentSearch" placeholder="Cerca per titolo..." onkeyup="filterCarouselContent()">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="addCarouselItem()" class="admin-button-small">
                            <i class="fas fa-plus"></i> Nuovo Contenuto
                        </button>
                        <button onclick="reorderCarouselItems()" class="admin-button-small">
                            <i class="fas fa-sort"></i> Riordina Contenuti
                        </button>
                    </div>
                </div>
                <div id="carouselItemsList" class="carousel-items-grid">
                    <!-- Carousel items will be loaded here -->
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-calendar-alt"></i> Gestione Calendario</h2>
                <div class="admin-controls">
                    <div class="filters">
                        <div class="location-filter">
                            <label for="calendarLocationFilter">Filtra per Sede:</label>
                            <select id="calendarLocationFilter" onchange="filterCalendarEvents()">
                                <option value="all">Tutte le Sedi</option>
                                <option value="TO1">TO1</option>
                                <option value="TO2">TO2</option>
                                <option value="TO3">TO3</option>
                            </select>
                        </div>
                        <div class="date-filter">
                            <label for="calendarDateFilter">Filtra per Data:</label>
                            <input type="date" id="calendarDateFilter" onchange="filterCalendarEvents()">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="addCalendarEvent()" class="admin-button-small">
                            <i class="fas fa-plus"></i> Nuovo Evento
                        </button>
                    </div>
                </div>
                <div id="calendarEventsList" class="substitutions-list">
                    <!-- Calendar events will be loaded here -->
                </div>
            </div>

            <!-- Substitutions Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-exchange-alt"></i> Gestione Sostituzioni</h2>
                <div class="admin-controls">
                    <div class="filters">
                        <div class="location-filter">
                            <label for="adminLocationFilter">Filtra per Sede:</label>
                            <select id="adminLocationFilter" onchange="filterAdminSubstitutions()">
                                <option value="all">Tutte le Sedi</option>
                                <option value="TO1">TO1</option>
                                <option value="TO2">TO2</option>
                                <option value="TO3">TO3</option>
                            </select>
                        </div>
                        <div class="date-filter">
                            <label for="adminDateFilter">Filtra per Data:</label>
                            <input type="date" id="adminDateFilter" onchange="filterAdminSubstitutions()">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="addSubstitution()" class="admin-button-small">
                            <i class="fas fa-plus"></i> Nuova Sostituzione
                        </button>
                        <button onclick="exportSubstitutions()" class="admin-button-small">
                            <i class="fas fa-download"></i> Esporta Sostituzioni
                        </button>
                    </div>
                </div>
                <div id="substitutionsList" class="substitutions-list">
                    <!-- Substitutions will be loaded here -->
                </div>
            </div>

            <!-- Organizational Structure Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-sitemap"></i> Gestione Organigramma</h2>
                <div class="admin-controls">
                    <button onclick="editOrgStructure()" class="admin-button-small">
                        <i class="fas fa-edit"></i> Modifica Struttura
                    </button>
                    <button onclick="updateOrgStructure()" class="admin-button-small">
                        <i class="fas fa-save"></i> Aggiorna Struttura
                    </button>
                </div>
            </div>
        </div>

        <!-- Substitution Modal -->
        <div id="substitutionModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gestione Sostituzione</h2>
                    <button onclick="closeSubstitutionModal()" class="close-button">&times;</button>
                </div>
                <form id="substitutionForm" onsubmit="handleSubstitutionSubmit(event)">
                    <input type="hidden" id="substitutionId">
                    <div class="form-group">
                        <label for="substitutionDate">Data:</label>
                        <input type="date" id="substitutionDate" required>
                    </div>
                    <div class="form-group">
                        <label for="substitutionLocation">Sede:</label>
                        <select id="substitutionLocation" required>
                            <option value="TO1">TO1</option>
                            <option value="TO2">TO2</option>
                            <option value="TO3">TO3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="substitutionTimeSlot">Orario:</label>
                        <select id="substitutionTimeSlot" required>
                            <option value="1">1° ora (8:00-9:00)</option>
                            <option value="2">2° ora (9:00-10:00)</option>
                            <option value="3">3° ora (10:00-11:00)</option>
                            <option value="4">4° ora (11:00-12:00)</option>
                            <option value="5">5° ora (12:00-13:00)</option>
                            <option value="6">6° ora (13:00-14:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="substitutionClass">Classe:</label>
                        <input type="text" id="substitutionClass" required placeholder="es. 1A">
                    </div>
                    <div class="form-group">
                        <label for="substitutionSubject">Materia:</label>
                        <input type="text" id="substitutionSubject" required>
                    </div>
                    <div class="form-group">
                        <label for="replacedTeacher">Docente Sostituito:</label>
                        <input type="text" id="replacedTeacher" required>
                    </div>
                    <div class="form-group">
                        <label for="substituteTeacher">Docente Sostituto:</label>
                        <input type="text" id="substituteTeacher" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="save-button">Salva</button>
                        <button type="button" onclick="closeSubstitutionModal()" class="cancel-button">Annulla</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Calendar Event Modal -->
        <div id="calendarEventModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gestione Evento</h2>
                    <button onclick="closeCalendarEventModal()" class="close-button">&times;</button>
                </div>
                <form id="calendarEventForm" onsubmit="handleCalendarEventSubmit(event)">
                    <input type="hidden" id="eventId">
                    <div class="form-group">
                        <label for="eventDate">Data:</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventLocation">Sede:</label>
                        <select id="eventLocation" required>
                            <option value="all">Tutte le Sedi</option>
                            <option value="TO1">TO1</option>
                            <option value="TO2">TO2</option>
                            <option value="TO3">TO3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventTimeSlot">Orario:</label>
                        <select id="eventTimeSlot" required>
                            <option value="1">1° ora (8:00-9:00)</option>
                            <option value="2">2° ora (9:00-10:00)</option>
                            <option value="3">3° ora (10:00-11:00)</option>
                            <option value="4">4° ora (11:00-12:00)</option>
                            <option value="5">5° ora (12:00-13:00)</option>
                            <option value="6">6° ora (13:00-14:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventTitle">Titolo Evento:</label>
                        <input type="text" id="eventTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDescription">Descrizione:</label>
                        <textarea id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="save-button">Salva</button>
                        <button type="button" onclick="closeCalendarEventModal()" class="cancel-button">Annulla</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Carousel Item Modal -->
        <div id="carouselItemModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gestione Contenuto Carosello</h2>
                    <button onclick="closeCarouselItemModal()" class="close-button">&times;</button>
                </div>
                <form id="carouselItemForm" onsubmit="handleCarouselItemSubmit(event)">
                    <input type="hidden" id="carouselItemId">
                    <div class="form-group">
                        <label for="itemType">Tipo Contenuto:</label>
                        <select id="itemType" required onchange="toggleMediaInput()">
                            <option value="image">Immagine</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="itemTitle">Titolo:</label>
                        <input type="text" id="itemTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="itemFile">File:</label>
                        <input type="file" id="itemFile" accept="image/*,video/*" required>
                        <div id="filePreview" class="file-preview"></div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="save-button">Salva</button>
                        <button type="button" onclick="closeCarouselItemModal()" class="cancel-button">Annulla</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="loginPrompt" class="login-prompt glass-effect">
            <i class="fas fa-lock"></i>
            <h2>Accesso Richiesto</h2>
            <p>Effettua l'accesso per gestire il sistema totem</p>
            <a href="admin-login.html" class="btn">
                <i class="fas fa-sign-in-alt"></i>
                Accedi
            </a>
        </div>

        <footer class="footer glass-effect">
            <p>© 2024 Totem Navigation | IIS P.Boselli Torino | Tutti i diritti riservati</p>
            <p class="footer-sub">Pannello di Amministrazione</p>
        </footer>
    </div>

    <script type="module">
        import { 
            onAuthChange,
            handleLogout,
            checkUserPermissions,
            isAuthenticated,
            getCurrentUser
        } from './js/firebase-admin.js';
        
        import { 
            getDatabase, 
            ref, 
            push, 
            update, 
            get, 
            query, 
            orderByChild, 
            onValue,
            remove
        } from "firebase/database";
        import { getAuth, signOut } from "firebase/auth";

        // Initialize Firebase services
        const db = getDatabase();
        const auth = getAuth();

        // Definisci items come variabile globale
        let items = [];
        let location = 'viasansovino'; // Valore di default

        // Aggiungi variabili globali per le sostituzioni
        let substitutions = [];
        let filteredSubstitutions = [];

        // Utility function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Verifica il tipo di file
                    const fileType = file.type;
                    console.log('Tipo di file caricato:', fileType); // Debug log
                    
                    if (fileType.startsWith('video/')) {
                        // Per i video, assicuriamoci di usare il tipo corretto
                        const base64Data = reader.result;
                        console.log('Video convertito in base64, lunghezza:', base64Data.length); // Debug log
                        resolve(base64Data);
                    } else if (fileType.startsWith('image/')) {
                        // Per le immagini
                        resolve(reader.result);
                    } else {
                        reject(new Error('Tipo di file non supportato'));
                    }
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Check authentication state and permissions
        onAuthChange(async (user) => {
            const loginPrompt = document.getElementById('loginPrompt');
            const adminContent = document.getElementById('adminContent');
            const adminUser = document.getElementById('adminUser');
            
            try {
                if (user) {
                    console.log('User authenticated in admin panel:', user.email);
                    loginPrompt.style.display = 'none';
                    adminContent.style.display = 'block';
                    adminUser.textContent = `Admin: ${user.email}`;
                    
                    // Carica i contenuti solo se l'utente è autenticato
                    loadCarouselContent();
                    loadSubstitutions('all', new Date().toISOString().split('T')[0]);
                    loadCalendarEvents('all', new Date().toISOString().split('T')[0]);
                } else {
                    console.log('No authenticated user, showing login prompt');
                    loginPrompt.style.display = 'block';
                    adminContent.style.display = 'none';
                    window.location.href = 'admin-login.html';
                }
            } catch (error) {
                console.error('Error in admin panel auth state change:', error);
                showError(error.message || 'Errore durante l\'accesso al pannello admin');
                loginPrompt.style.display = 'block';
                adminContent.style.display = 'none';
                setTimeout(() => {
                    window.location.href = 'admin-login.html';
                }, 2000);
            }
        });

        // Handle logout
        window.handleLogout = async () => {
            try {
                console.log('Logging out user');
                await handleLogout();
                console.log('User logged out successfully');
            } catch (error) {
                console.error('Error during logout:', error);
                showError('Errore durante il logout. Riprova.');
            }
        };

        // Carousel Management Functions
        window.addCarouselItem = () => {
            const modal = document.getElementById('carouselItemModal');
            const form = document.getElementById('carouselItemForm');
            
            document.getElementById('carouselItemId').value = '';
            document.getElementById('itemType').value = 'image';
            document.getElementById('itemTitle').value = '';
            document.getElementById('itemFile').value = '';
            document.getElementById('filePreview').innerHTML = '';
            
            modal.style.display = 'block';
        };

        window.closeCarouselItemModal = () => {
            document.getElementById('carouselItemModal').style.display = 'none';
        };

        window.toggleMediaInput = () => {
            const type = document.getElementById('itemType').value;
            const fileInput = document.getElementById('itemFile');
            fileInput.accept = type === 'image' ? 'image/*' : 'video/*';
        };

        window.handleCarouselItemSubmit = async (event) => {
            event.preventDefault();
            
            const location = document.getElementById('carouselLocation').value;
            const itemId = document.getElementById('carouselItemId').value;
            const type = document.getElementById('itemType').value;
            const title = document.getElementById('itemTitle').value;
            const file = document.getElementById('itemFile').files[0];

            if (!file) {
                alert('Seleziona un file');
                return;
            }

            try {
                // Verifica la corrispondenza tra tipo selezionato e tipo di file
                const fileType = file.type;
                if ((type === 'video' && !fileType.startsWith('video/')) ||
                    (type === 'image' && !fileType.startsWith('image/'))) {
                    alert('Il tipo di file non corrisponde al tipo selezionato');
                    return;
                }

                console.log('Caricamento file:', {
                    nome: file.name,
                    tipo: file.type,
                    dimensione: file.size
                }); // Debug log

                // Convert file to base64
                const base64Data = await fileToBase64(file);
                console.log('File convertito in base64, tipo:', type); // Debug log

                // Get current items to determine next order number
                const carouselRef = ref(db, `carousel/${location}`);
                const snapshot = await get(carouselRef);
                let nextOrder = 1;
                
                if (snapshot.exists()) {
                    const items = snapshot.val();
                    const orders = Object.values(items).map(item => item.order || 0);
                    nextOrder = Math.max(...orders) + 1;
                }

                // Save item data to Realtime Database
                const itemData = {
                    type,
                    title,
                    data: base64Data,
                    order: nextOrder,
                    fileType: file.type, // Aggiungiamo il tipo di file originale
                    updatedAt: new Date().toISOString()
                };

                if (itemId) {
                    // Update existing item
                    await update(ref(db, `carousel/${location}/${itemId}`), itemData);
                } else {
                    // Add new item
                    await push(ref(db, `carousel/${location}`), itemData);
                }

                closeCarouselItemModal();
                loadCarouselContent();
                showSuccess('Contenuto salvato con successo');
            } catch (error) {
                console.error('Error saving carousel item:', error);
                showError('Errore durante il salvataggio del contenuto: ' + error.message);
            }
        };

        window.deleteCarouselItem = async (location, itemId) => {
            if (confirm('Sei sicuro di voler eliminare questo contenuto?')) {
                try {
                    // Delete item from Database
                    await remove(ref(db, `carousel/${location}/${itemId}`));
                    loadCarouselContent();
                    showSuccess('Contenuto eliminato con successo');
                } catch (error) {
                    console.error('Error deleting carousel item:', error);
                    showError('Errore durante l\'eliminazione del contenuto');
                }
            }
        };

        window.loadCarouselContent = () => {
            location = document.getElementById('carouselLocation').value;
            const itemsList = document.getElementById('carouselItemsList');
            
            console.log('Caricamento contenuti per:', location); // Debug log
            
            const carouselRef = ref(db, `carousel/${location}`);
            onValue(carouselRef, (snapshot) => {
                items = []; // Reset items array
                itemsList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    console.log('Nessun contenuto trovato'); // Debug log
                    itemsList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-images"></i>
                            <p>Nessun contenuto trovato per questa sede</p>
                        </div>
                    `;
                    return;
                }

                console.log('Contenuti trovati:', snapshot.size); // Debug log
                
                snapshot.forEach((childSnapshot) => {
                    const item = childSnapshot.val();
                    item.id = childSnapshot.key;
                    items.push(item);
                    console.log('Item caricato:', item); // Debug log
                });
                
                console.log('Totale items caricati:', items.length); // Debug log
                filterCarouselContent();
            }, (error) => {
                console.error('Errore nel caricamento dei contenuti:', error);
                itemsList.innerHTML = `
                    <div class="no-data error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Errore nel caricamento dei contenuti</p>
                    </div>
                `;
            });
        };

        // Initialize carousel content when admin panel is shown
        onAuthChange((user) => {
            if (user) {
                loadCarouselContent();
            }
        });

        // File preview
        document.getElementById('itemFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';
            
            console.log('File selezionato:', {
                nome: file.name,
                tipo: file.type,
                dimensione: file.size
            }); // Debug log

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                preview.appendChild(img);
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '200px';
                preview.appendChild(video);
            } else {
                preview.innerHTML = '<p>Tipo di file non supportato</p>';
            }
        });

        // Calendar functions
        window.editCalendar = () => {
            // Implement calendar editing interface
            showInfo('Funzionalità in sviluppo');
        };

        window.exportCalendar = async () => {
            try {
                const events = await exportCalendarData();
                downloadJSON(events, 'calendar.json');
                showSuccess('Calendario esportato con successo');
            } catch (error) {
                console.error('Error exporting calendar:', error);
                showError('Errore nell\'esportazione del calendario');
            }
        };

        // Substitutions functions
        window.addSubstitution = () => {
            const modal = document.getElementById('substitutionModal');
            const form = document.getElementById('substitutionForm');
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('substitutionId').value = '';
            document.getElementById('substitutionDate').value = today;
            document.getElementById('substitutionLocation').value = 'TO1';
            document.getElementById('substitutionTimeSlot').value = '1';
            document.getElementById('substitutionClass').value = '';
            document.getElementById('substitutionSubject').value = '';
            document.getElementById('replacedTeacher').value = '';
            document.getElementById('substituteTeacher').value = '';
            
            modal.style.display = 'block';
        };

        window.editSubstitution = (substitutionId) => {
            const substitutionRef = ref(db, `substitutions/${substitutionId}`);
            get(substitutionRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const substitution = snapshot.val();
                    const modal = document.getElementById('substitutionModal');
                    
                    document.getElementById('substitutionId').value = substitutionId;
                    document.getElementById('substitutionDate').value = substitution.date;
                    document.getElementById('substitutionLocation').value = substitution.location;
                    document.getElementById('substitutionTimeSlot').value = substitution.timeSlot;
                    document.getElementById('substitutionClass').value = substitution.class;
                    document.getElementById('substitutionSubject').value = substitution.subject;
                    document.getElementById('replacedTeacher').value = substitution.replacedTeacher;
                    document.getElementById('substituteTeacher').value = substitution.substituteTeacher;
                    
                    modal.style.display = 'block';
                }
            });
        };

        window.closeSubstitutionModal = () => {
            document.getElementById('substitutionModal').style.display = 'none';
        };

        window.handleSubstitutionSubmit = async (event) => {
            event.preventDefault();
            
            const substitutionId = document.getElementById('substitutionId').value;
            const substitution = {
                date: document.getElementById('substitutionDate').value,
                location: document.getElementById('substitutionLocation').value,
                timeSlot: document.getElementById('substitutionTimeSlot').value,
                class: document.getElementById('substitutionClass').value,
                subject: document.getElementById('substitutionSubject').value,
                replacedTeacher: document.getElementById('replacedTeacher').value,
                substituteTeacher: document.getElementById('substituteTeacher').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (substitutionId) {
                    // Update existing substitution
                    await update(ref(db, `substitutions/${substitutionId}`), substitution);
                    showSuccess('Sostituzione aggiornata con successo');
                } else {
                    // Add new substitution
                    await push(ref(db, 'substitutions'), substitution);
                    showSuccess('Sostituzione aggiunta con successo');
                }
                closeSubstitutionModal();
                loadSubstitutions(); // Ricarica tutte le sostituzioni
            } catch (error) {
                console.error('Error saving substitution:', error);
                showError('Errore durante il salvataggio della sostituzione: ' + error.message);
            }
        };

        window.deleteSubstitution = async (substitutionId) => {
            if (confirm('Sei sicuro di voler eliminare questa sostituzione?')) {
                try {
                    await remove(ref(db, `substitutions/${substitutionId}`));
                    showSuccess('Sostituzione eliminata con successo');
                    loadSubstitutions(); // Ricarica tutte le sostituzioni
                } catch (error) {
                    console.error('Error deleting substitution:', error);
                    showError('Errore durante l\'eliminazione della sostituzione: ' + error.message);
                }
            }
        };

        // Function to filter substitutions in admin panel
        window.filterAdminSubstitutions = () => {
            const selectedLocation = document.getElementById('adminLocationFilter').value;
            const selectedDate = document.getElementById('adminDateFilter').value;
            console.log('Filtro sostituzioni admin:', { location: selectedLocation, date: selectedDate }); // Debug log
            filterSubstitutions(selectedLocation, selectedDate);
        };

        // Function to load and display substitutions with filters
        function loadSubstitutions(location = 'all', date = '') {
            console.log('Loading substitutions with filters:', { location, date }); // Debug log
            
            const substitutionsRef = ref(db, 'substitutions');
            const substitutionsQuery = query(substitutionsRef, orderByChild('date'));

            onValue(substitutionsQuery, (snapshot) => {
                console.log('Snapshot received:', snapshot.exists()); // Debug log
                const substitutionsList = document.getElementById('substitutionsList');
                substitutionsList.innerHTML = '';

                substitutions = []; // Reset array
                if (!snapshot.exists()) {
                    console.log('Nessuna sostituzione trovata'); // Debug log
                    substitutionsList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-calendar-check"></i>
                            <p>Nessuna sostituzione trovata</p>
                        </div>
                    `;
                    return;
                }

                // Raccogli tutte le sostituzioni
                snapshot.forEach((childSnapshot) => {
                    const substitution = childSnapshot.val();
                    substitution.id = childSnapshot.key;
                    substitutions.push(substitution);
                    console.log('Sostituzione caricata:', substitution); // Debug log
                });

                console.log('Totale sostituzioni caricate:', substitutions.length); // Debug log
                filterSubstitutions(location, date);
            }, (error) => {
                console.error('Error loading substitutions:', error);
                const substitutionsList = document.getElementById('substitutionsList');
                substitutionsList.innerHTML = `
                    <div class="no-data error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Errore nel caricamento delle sostituzioni</p>
                    </div>
                `;
            });
        }

        // Nuova funzione per filtrare le sostituzioni
        function filterSubstitutions(location = 'all', date = '') {
            console.log('Filtro sostituzioni:', { location, date, total: substitutions.length }); // Debug log
            
            const substitutionsList = document.getElementById('substitutionsList');
            substitutionsList.innerHTML = '';

            // Filtra le sostituzioni
            filteredSubstitutions = substitutions.filter(substitution => {
                const matchesLocation = location === 'all' || substitution.location === location;
                const matchesDate = !date || substitution.date === date;
                return matchesLocation && matchesDate;
            });

            console.log('Sostituzioni filtrate:', filteredSubstitutions.length); // Debug log

            if (filteredSubstitutions.length === 0) {
                substitutionsList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-calendar-check"></i>
                        <p>Nessuna sostituzione trovata con i filtri selezionati</p>
                    </div>
                `;
                return;
            }

            // Ordina le sostituzioni per data e ora
            filteredSubstitutions.sort((a, b) => {
                if (a.date === b.date) {
                    return parseInt(a.timeSlot) - parseInt(b.timeSlot);
                }
                return a.date.localeCompare(b.date);
            });

            // Raggruppa per data
            const groupedSubstitutions = filteredSubstitutions.reduce((groups, substitution) => {
                const date = substitution.date;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(substitution);
                return groups;
            }, {});

            // Crea HTML per ogni gruppo di date
            Object.entries(groupedSubstitutions).forEach(([date, dateSubstitutions]) => {
                const dateHeader = document.createElement('div');
                dateHeader.className = 'date-group-header';
                dateHeader.innerHTML = `
                    <h3>${new Date(date).toLocaleDateString('it-IT', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</h3>
                `;
                substitutionsList.appendChild(dateHeader);

                dateSubstitutions.forEach(substitution => {
                    const substitutionElement = document.createElement('div');
                    substitutionElement.className = 'substitution-item';
                    substitutionElement.innerHTML = `
                        <div class="substitution-info">
                            <div class="substitution-header">
                                <span class="location">${substitution.location}</span>
                                <span class="time">${getTimeSlotText(substitution.timeSlot)}</span>
                            </div>
                            <div class="substitution-details">
                                <span class="class">Classe: ${substitution.class || 'N/A'}</span>
                                <span class="subject">Materia: ${substitution.subject || 'N/A'}</span>
                                <span class="teachers">
                                    <span class="replaced">Sostituito: ${substitution.replacedTeacher || 'N/A'}</span>
                                    <span class="substitute">Sostituto: ${substitution.substituteTeacher || 'N/A'}</span>
                                </span>
                            </div>
                        </div>
                        <div class="substitution-actions">
                            <button onclick="editSubstitution('${substitution.id}')" class="edit-button">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSubstitution('${substitution.id}')" class="delete-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    substitutionsList.appendChild(substitutionElement);
                });
            });
        }

        // Initialize filters and load substitutions when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const adminDateFilter = document.getElementById('adminDateFilter');
            if (adminDateFilter) {
                adminDateFilter.value = today;
                loadSubstitutions('all', today);
            }
        });

        // Load substitutions when admin panel is shown
        onAuthChange((user) => {
            if (user) {
                const today = new Date().toISOString().split('T')[0];
                loadSubstitutions('all', today);
            }
        });

        // Organizational structure functions
        window.editOrgStructure = async () => {
            try {
                const structure = await getOrgStructure();
                if (structure) {
                    // Implement structure editing interface
                    showInfo('Funzionalità in sviluppo');
                }
            } catch (error) {
                console.error('Error loading org structure:', error);
                showError('Errore nel caricamento della struttura');
            }
        };

        window.updateOrgStructure = async () => {
            try {
                // Implement structure update interface
                showInfo('Funzionalità in sviluppo');
            } catch (error) {
                console.error('Error updating org structure:', error);
                showError('Errore nell\'aggiornamento della struttura');
            }
        };

        // Utility functions
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showSuccess(message) {
            alert(message); // Replace with better UI
        }

        function showError(message) {
            alert(message); // Replace with better UI
        }

        function showInfo(message) {
            alert(message); // Replace with better UI
        }

        // Calendar Event Functions
        window.addCalendarEvent = () => {
            const modal = document.getElementById('calendarEventModal');
            const form = document.getElementById('calendarEventForm');
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('eventId').value = '';
            document.getElementById('eventDate').value = today;
            document.getElementById('eventLocation').value = 'all';
            document.getElementById('eventTimeSlot').value = '1';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            
            modal.style.display = 'block';
        };

        window.editCalendarEvent = (eventId) => {
            const eventRef = ref(db, `calendar/${eventId}`);
            get(eventRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const event = snapshot.val();
                    const modal = document.getElementById('calendarEventModal');
                    
                    document.getElementById('eventId').value = eventId;
                    document.getElementById('eventDate').value = event.date;
                    document.getElementById('eventLocation').value = event.location;
                    document.getElementById('eventTimeSlot').value = event.timeSlot;
                    document.getElementById('eventTitle').value = event.title;
                    document.getElementById('eventDescription').value = event.description || '';
                    
                    modal.style.display = 'block';
                }
            });
        };

        window.closeCalendarEventModal = () => {
            document.getElementById('calendarEventModal').style.display = 'none';
        };

        window.handleCalendarEventSubmit = async (event) => {
            event.preventDefault();
            
            const eventId = document.getElementById('eventId').value;
            const calendarEvent = {
                date: document.getElementById('eventDate').value,
                location: document.getElementById('eventLocation').value,
                timeSlot: document.getElementById('eventTimeSlot').value,
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (eventId) {
                    await update(ref(db, `calendar/${eventId}`), calendarEvent);
                } else {
                    await push(ref(db, 'calendar'), calendarEvent);
                }
                closeCalendarEventModal();
                loadCalendarEvents();
            } catch (error) {
                console.error('Error saving calendar event:', error);
                alert('Errore durante il salvataggio dell\'evento');
            }
        };

        window.deleteCalendarEvent = async (eventId) => {
            if (confirm('Sei sicuro di voler eliminare questo evento?')) {
                try {
                    await remove(ref(db, `calendar/${eventId}`));
                    loadCalendarEvents();
                } catch (error) {
                    console.error('Error deleting calendar event:', error);
                    alert('Errore durante l\'eliminazione dell\'evento');
                }
            }
        };

        window.filterCalendarEvents = () => {
            const selectedLocation = document.getElementById('calendarLocationFilter').value;
            const selectedDate = document.getElementById('calendarDateFilter').value;
            loadCalendarEvents(selectedLocation, selectedDate);
        };

        function loadCalendarEvents(location = 'all', date = '') {
            console.log('Loading calendar events with filters:', { location, date });
            const eventsRef = ref(db, 'calendar');
            const eventsQuery = query(eventsRef, orderByChild('date'));

            onValue(eventsQuery, (snapshot) => {
                console.log('Calendar snapshot received:', snapshot.exists());
                const eventsList = document.getElementById('calendarEventsList');
                eventsList.innerHTML = '';

                const events = [];
                snapshot.forEach((childSnapshot) => {
                    const event = childSnapshot.val();
                    console.log('Processing event:', event);
                    if ((location === 'all' || event.location === location) &&
                        (!date || event.date === date)) {
                        event.id = childSnapshot.key;
                        events.push(event);
                    }
                });

                console.log('Filtered events:', events);

                if (events.length === 0) {
                    eventsList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-calendar-check"></i>
                            <p>Nessun evento trovato con i filtri selezionati</p>
                        </div>
                    `;
                    return;
                }

                // Sort events by date and time slot
                events.sort((a, b) => {
                    if (a.date === b.date) {
                        return parseInt(a.timeSlot) - parseInt(b.timeSlot);
                    }
                    return a.date.localeCompare(b.date);
                });

                // Group events by date
                const groupedEvents = events.reduce((groups, event) => {
                    const date = event.date;
                    if (!groups[date]) {
                        groups[date] = [];
                    }
                    groups[date].push(event);
                    return groups;
                }, {});

                // Create HTML for each date group
                Object.entries(groupedEvents).forEach(([date, dateEvents]) => {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'date-group-header';
                    dateHeader.innerHTML = `
                        <h3>${new Date(date).toLocaleDateString('it-IT', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</h3>
                    `;
                    eventsList.appendChild(dateHeader);

                    dateEvents.forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'substitution-item';
                        eventElement.innerHTML = `
                            <div class="substitution-info">
                                <div class="substitution-header">
                                    <span class="location">${event.location === 'all' ? 'Tutte le Sedi' : event.location}</span>
                                    <span class="time">${getTimeSlotText(event.timeSlot)}</span>
                                </div>
                                <div class="substitution-details">
                                    <span class="title">${event.title}</span>
                                    ${event.description ? `<span class="description">${event.description}</span>` : ''}
                                </div>
                            </div>
                            <div class="substitution-actions">
                                <button onclick="editCalendarEvent('${event.id}')" class="edit-button">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteCalendarEvent('${event.id}')" class="delete-button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        eventsList.appendChild(eventElement);
                    });
                });
            }, (error) => {
                console.error('Error loading calendar events:', error);
                const eventsList = document.getElementById('calendarEventsList');
                eventsList.innerHTML = `
                    <div class="no-data error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Errore nel caricamento degli eventi</p>
                    </div>
                `;
            });
        }

        // Initialize calendar filters and load events when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const calendarDateFilter = document.getElementById('calendarDateFilter');
            if (calendarDateFilter) {
                calendarDateFilter.value = today;
                loadCalendarEvents('all', today);
            }
        });

        // Load calendar events when admin panel is shown
        onAuthChange((user) => {
            if (user) {
                const today = new Date().toISOString().split('T')[0];
                loadCalendarEvents('all', today);
            }
        });

        window.filterCarouselContent = () => {
            console.log('Filtro contenuti, items disponibili:', items.length); // Debug log
            
            const typeFilter = document.getElementById('contentTypeFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const searchQuery = document.getElementById('contentSearch').value.toLowerCase();
            const itemsList = document.getElementById('carouselItemsList');
            
            if (!items || items.length === 0) {
                console.log('Nessun item da filtrare'); // Debug log
                itemsList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-images"></i>
                        <p>Nessun contenuto disponibile</p>
                    </div>
                `;
                return;
            }
            
            // Filtra gli elementi
            const filteredItems = items.filter(item => {
                const matchesType = typeFilter === 'all' || item.type === typeFilter;
                const matchesSearch = item.title.toLowerCase().includes(searchQuery);
                return matchesType && matchesSearch;
            });
            
            console.log('Items filtrati:', filteredItems.length); // Debug log

            // Ordina gli elementi
            filteredItems.sort((a, b) => {
                switch(sortOrder) {
                    case 'order':
                        return (a.order || 0) - (b.order || 0);
                    case 'date':
                        return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
                    case 'title':
                        return (a.title || '').localeCompare(b.title || '');
                    default:
                        return 0;
                }
            });

            // Aggiorna la visualizzazione
            itemsList.innerHTML = '';
            if (filteredItems.length === 0) {
                itemsList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-search"></i>
                        <p>Nessun contenuto corrisponde ai filtri selezionati</p>
                    </div>
                `;
                return;
            }
            
            filteredItems.forEach(item => {
                const itemElement = createCarouselItemElement(item);
                itemsList.appendChild(itemElement);
            });
        };

        function createCarouselItemElement(item) {
            console.log('Creazione elemento per:', item); // Debug log
            
            const itemElement = document.createElement('div');
            itemElement.className = 'carousel-item-card';
            
            const previewContent = item.type === 'image' 
                ? `<img src="${item.data}" alt="${item.title || 'Immagine'}" class="carousel-item-preview">`
                : `<video src="${item.data}" class="carousel-item-preview" muted></video>`;
            
            const date = item.updatedAt 
                ? new Date(item.updatedAt).toLocaleDateString('it-IT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
                : 'Data non disponibile';
            
            itemElement.innerHTML = `
                ${previewContent}
                <div class="carousel-item-info">
                    <div class="carousel-item-header">
                        <div class="carousel-item-title">
                            <span class="item-number">${item.order || '?'}</span>
                            ${item.title || 'Senza titolo'}
                        </div>
                    </div>
                    <div class="carousel-item-meta">
                        <div class="carousel-item-type">
                            <i class="fas fa-${item.type === 'image' ? 'image' : 'video'}"></i>
                            ${item.type === 'image' ? 'Immagine' : 'Video'}
                        </div>
                        <div class="carousel-item-date">
                            <i class="fas fa-clock"></i> Caricato il ${date}
                        </div>
                    </div>
                    <div class="carousel-item-actions">
                        <button onclick="editCarouselItem('${item.id}')" class="edit-button">
                            <i class="fas fa-edit"></i> Modifica
                        </button>
                        <button onclick="deleteCarouselItem('${location}', '${item.id}')" class="delete-button">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </div>
                </div>
            `;
            
            return itemElement;
        }

        window.reorderCarouselItems = () => {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Riordina Contenuti</h2>
                        <button onclick="this.closest('.modal').remove()" class="close-button">&times;</button>
                    </div>
                    <div class="reorder-list">
                        ${items.map((item, index) => `
                            <div class="reorder-item" data-id="${item.id}">
                                <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
                                <span class="item-preview">
                                    ${item.type === 'image' 
                                        ? `<img src="${item.data}" alt="${item.title}">`
                                        : `<video src="${item.data}" muted></video>`}
                                </span>
                                <span class="item-title">${item.title}</span>
                                <span class="item-number">${item.order}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="modal-actions">
                        <button onclick="saveNewOrder()" class="save-button">Salva Ordine</button>
                        <button onclick="this.closest('.modal').remove()" class="cancel-button">Annulla</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            initializeDragAndDrop();
        };

        function initializeDragAndDrop() {
            const reorderList = document.querySelector('.reorder-list');
            if (!reorderList) return;

            new Sortable(reorderList, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function() {
                    updateOrderNumbers();
                }
            });
        }

        function updateOrderNumbers() {
            const items = document.querySelectorAll('.reorder-item');
            items.forEach((item, index) => {
                item.querySelector('.item-number').textContent = index + 1;
            });
        }

        window.saveNewOrder = async () => {
            const items = document.querySelectorAll('.reorder-item');
            const updates = {};
            
            items.forEach((item, index) => {
                const itemId = item.dataset.id;
                updates[`carousel/${location}/${itemId}/order`] = index + 1;
            });
            
            try {
                await update(ref(db), updates);
                showSuccess('Ordine aggiornato con successo');
                loadCarouselContent();
                document.querySelector('.modal').remove();
            } catch (error) {
                console.error('Error updating order:', error);
                showError('Errore durante l\'aggiornamento dell\'ordine');
            }
        };

        // Utility function per il testo dell'orario
        function getTimeSlotText(timeSlot) {
            const timeSlots = {
                '1': '1° ora (8:00-9:00)',
                '2': '2° ora (9:00-10:00)',
                '3': '3° ora (10:00-11:00)',
                '4': '4° ora (11:00-12:00)',
                '5': '5° ora (12:00-13:00)',
                '6': '6° ora (13:00-14:00)'
            };
            return timeSlots[timeSlot] || `Orario ${timeSlot}`;
        }

        // Funzione per mostrare messaggi di feedback
        function showFeedback(message, type = 'info') {
            console.log(`Showing ${type} feedback:`, message);
            const feedback = document.createElement('div');
            feedback.className = `feedback-message ${type}`;
            feedback.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            // Rimuovi eventuali messaggi precedenti
            document.querySelectorAll('.feedback-message').forEach(msg => msg.remove());
            
            document.body.appendChild(feedback);
            
            // Aggiungi stili per il feedback
            feedback.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 
                             type === 'error' ? 'rgba(244, 67, 54, 0.9)' : 
                             'rgba(33, 150, 243, 0.9)'};
                color: white;
                z-index: 9999;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease-out;
            `;
            
            setTimeout(() => {
                feedback.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => feedback.remove(), 300);
            }, 5000);
        }

        // Aggiorna le funzioni di gestione degli eventi per usare il nuovo sistema di feedback
        window.showSuccess = (message) => showFeedback(message, 'success');
        window.showError = (message) => showFeedback(message, 'error');
        window.showInfo = (message) => showFeedback(message, 'info');

        // Funzione per gestire lo scroll-to-top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Mostra/nascondi il pulsante scroll-to-top
        window.onscroll = function() {
            const scrollTop = document.getElementById('scrollTop');
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollTop.classList.add('visible');
            } else {
                scrollTop.classList.remove('visible');
            }
        };
    </script>

    <style>
        .admin-section {
            margin: 2rem 0;
            padding: 2rem;
        }

        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .admin-button-small {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .admin-button-small:hover {
            background: var(--primary-color-dark);
            transform: translateY(-2px);
        }

        .admin-button-small i {
            font-size: 1.2rem;
        }

        .login-prompt {
            text-align: center;
            padding: 3rem;
            margin: 2rem auto;
            max-width: 400px;
        }

        .login-prompt i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .admin-header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-user {
            color: #fff;
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            width: 90%;
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 15px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Substitutions List Styles */
        .substitutions-list {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .substitution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .substitution-info {
            flex: 1;
        }

        .substitution-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .substitution-header .location {
            color: var(--primary-color);
            font-weight: 600;
        }

        .substitution-details {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .substitution-actions {
            display: flex;
            gap: 0.5rem;
        }

        .edit-button,
        .delete-button {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .edit-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary-color);
        }

        .delete-button {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }

        .edit-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .delete-button:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        @media screen and (max-width: 768px) {
            .substitution-item {
                flex-direction: column;
                gap: 1rem;
            }

            .substitution-header {
                flex-direction: column;
                gap: 0.25rem;
            }

            .substitution-details {
                flex-direction: column;
                gap: 0.5rem;
            }

            .substitution-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .location-filter,
        .date-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 200px;
        }

        .location-filter select,
        .date-filter input {
            padding: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            flex: 1;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .date-group-header {
            margin: 1.5rem 0 0.5rem 0;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .date-group-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--text-color);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .no-data i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        @media screen and (max-width: 768px) {
            .filters {
                flex-direction: column;
            }

            .location-filter,
            .date-filter {
                width: 100%;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .admin-button-small {
                width: 100%;
            }
        }

        .no-data.error {
            color: #ff6b6b;
        }

        .no-data.error i {
            color: #ff6b6b;
        }

        .events-list {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .event-info {
            flex: 1;
        }

        .event-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .event-header .location {
            color: var(--primary-color);
            font-weight: 600;
        }

        .event-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .event-details .title {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .event-details .description {
            margin: 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .event-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        @media screen and (max-width: 768px) {
            .event-item {
                flex-direction: column;
                gap: 1rem;
            }

            .event-header {
                flex-direction: column;
                gap: 0.25rem;
            }

            .event-actions {
                width: 100%;
                justify-content: flex-end;
                margin-left: 0;
            }
        }

        .carousel-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 10px;
        }

        .carousel-item-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .carousel-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .carousel-item-preview {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 8px;
            background: #000;
            margin-bottom: 15px;
        }

        .carousel-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .carousel-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .carousel-item-title {
            font-size: 1.1em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 0.9em;
            font-weight: bold;
        }

        .carousel-item-meta {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
        }

        .carousel-item-type {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--primary-color);
        }

        .carousel-item-date {
            font-size: 0.8em;
        }

        .carousel-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filters-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            margin-bottom: 20px;
        }

        .content-filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group select {
            padding: 8px 12px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 150px;
        }

        .search-group {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-group input {
            width: 100%;
            padding: 8px 12px;
            padding-right: 35px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .search-group i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
        }

        @media screen and (max-width: 768px) {
            .carousel-items-grid {
                grid-template-columns: 1fr;
            }

            .content-filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
            }

            .filter-group select {
                width: 100%;
            }

            .search-group {
                width: 100%;
            }
        }

        /* Stili per i popup fluttuanti */
        .floating-form {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none; /* Cambiato da flex a none */
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .floating-form.active {
            display: flex; /* Mostra il form come flex quando è attivo */
        }

        /* Overlay per il popup */
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .form-overlay.active {
            display: block;
            opacity: 1;
        }

        .form-container {
            background: #ffffff;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            margin: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .form-header {
            background: #ffffff;
            padding: 1.5rem;
            border-bottom: 2px solid var(--primary-color);
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-header h2 {
            margin: 0;
            color: #333333;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .form-header .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-header .close-button:hover {
            background: #f0f0f0;
            color: #333333;
        }

        .form-content {
            padding: 2rem;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
            background: #ffffff;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333333;
            font-weight: 500;
            font-size: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #ffffff;
            color: #333333;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #999999;
        }

        .form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        .form-group input[type="file"] {
            padding: 1rem;
            background: #f8f9fa;
            border: 2px dashed #e0e0e0;
            cursor: pointer;
            color: #666666;
        }

        .form-group input[type="file"]:hover {
            border-color: var(--primary-color);
            background: #f0f0f0;
        }

        .file-preview {
            margin-top: 1rem;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            padding: 1rem;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .form-actions {
            background: #ffffff;
            padding: 1.5rem;
            border-top: 1px solid #e0e0e0;
            border-radius: 0 0 15px 15px;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .form-actions button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
            justify-content: center;
        }

        .save-button {
            background: var(--primary-color);
            color: #ffffff;
        }

        .save-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .cancel-button {
            background: #f8f9fa;
            color: #666666;
            border: 1px solid #e0e0e0;
        }

        .cancel-button:hover {
            background: #e9ecef;
            color: #333333;
        }

        /* Stili per la scrollbar del form */
        .form-content::-webkit-scrollbar {
            width: 8px;
        }

        .form-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .form-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .form-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Scroll to top button */
        .scroll-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .scroll-top:hover {
            transform: translateY(-2px);
            background: var(--primary-dark);
        }

        .scroll-top.visible {
            display: flex;
        }
    </style>

    <!-- Overlay per i form -->
    <div id="formOverlay" class="form-overlay"></div>

    <!-- Form fluttuante per il carosello -->
    <div id="carouselForm" class="floating-form">
        <div class="form-container">
            <div class="form-header">
                <h2><i class="fas fa-images"></i> Gestione Contenuto Carosello</h2>
                <button class="close-button" onclick="closeFloatingForm('carouselForm')">&times;</button>
            </div>
            <div class="form-content">
                <form id="carouselItemForm" onsubmit="handleCarouselItemSubmit(event)">
                    <input type="hidden" id="carouselItemId">
                    <div class="form-group">
                        <label for="itemType">Tipo Contenuto:</label>
                        <select id="itemType" required onchange="toggleMediaInput()">
                            <option value="image">Immagine</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="itemTitle">Titolo:</label>
                        <input type="text" id="itemTitle" required placeholder="Inserisci il titolo del contenuto">
                    </div>
                    <div class="form-group">
                        <label for="itemFile">File:</label>
                        <input type="file" id="itemFile" accept="image/*,video/*" required>
                        <div id="filePreview" class="file-preview"></div>
                    </div>
                </form>
            </div>
            <div class="form-actions">
                <button type="button" class="cancel-button" onclick="closeFloatingForm('carouselForm')">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button type="submit" form="carouselItemForm" class="save-button">
                    <i class="fas fa-save"></i> Salva
                </button>
            </div>
        </div>
    </div>

    <!-- Form fluttuante per gli eventi del calendario -->
    <div id="calendarForm" class="floating-form">
        <div class="form-container">
            <div class="form-header">
                <h2><i class="fas fa-calendar-alt"></i> Gestione Evento</h2>
                <button class="close-button" onclick="closeFloatingForm('calendarForm')">&times;</button>
            </div>
            <div class="form-content">
                <form id="calendarEventForm" onsubmit="handleCalendarEventSubmit(event)">
                    <input type="hidden" id="eventId">
                    <div class="form-group">
                        <label for="eventDate">Data:</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventLocation">Sede:</label>
                        <select id="eventLocation" required>
                            <option value="all">Tutte le Sedi</option>
                            <option value="TO1">TO1</option>
                            <option value="TO2">TO2</option>
                            <option value="TO3">TO3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventTimeSlot">Orario:</label>
                        <select id="eventTimeSlot" required>
                            <option value="1">1° ora (8:00-9:00)</option>
                            <option value="2">2° ora (9:00-10:00)</option>
                            <option value="3">3° ora (10:00-11:00)</option>
                            <option value="4">4° ora (11:00-12:00)</option>
                            <option value="5">5° ora (12:00-13:00)</option>
                            <option value="6">6° ora (13:00-14:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventTitle">Titolo Evento:</label>
                        <input type="text" id="eventTitle" required placeholder="Inserisci il titolo dell'evento">
                    </div>
                    <div class="form-group">
                        <label for="eventDescription">Descrizione:</label>
                        <textarea id="eventDescription" rows="3" placeholder="Inserisci una descrizione dell'evento"></textarea>
                    </div>
                </form>
            </div>
            <div class="form-actions">
                <button type="button" class="cancel-button" onclick="closeFloatingForm('calendarForm')">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button type="submit" form="calendarEventForm" class="save-button">
                    <i class="fas fa-save"></i> Salva
                </button>
            </div>
        </div>
    </div>

    <!-- Form fluttuante per le sostituzioni -->
    <div id="substitutionForm" class="floating-form">
        <div class="form-container">
            <div class="form-header">
                <h2><i class="fas fa-exchange-alt"></i> Gestione Sostituzione</h2>
                <button class="close-button" onclick="closeFloatingForm('substitutionForm')">&times;</button>
            </div>
            <div class="form-content">
                <form id="substitutionFormContent" onsubmit="handleSubstitutionSubmit(event)">
                    <input type="hidden" id="substitutionId">
                    <div class="form-group">
                        <label for="substitutionDate">Data:</label>
                        <input type="date" id="substitutionDate" required>
                    </div>
                    <div class="form-group">
                        <label for="substitutionLocation">Sede:</label>
                        <select id="substitutionLocation" required>
                            <option value="TO1">TO1</option>
                            <option value="TO2">TO2</option>
                            <option value="TO3">TO3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="substitutionTimeSlot">Orario:</label>
                        <select id="substitutionTimeSlot" required>
                            <option value="1">1° ora (8:00-9:00)</option>
                            <option value="2">2° ora (9:00-10:00)</option>
                            <option value="3">3° ora (10:00-11:00)</option>
                            <option value="4">4° ora (11:00-12:00)</option>
                            <option value="5">5° ora (12:00-13:00)</option>
                            <option value="6">6° ora (13:00-14:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="substitutionClass">Classe:</label>
                        <input type="text" id="substitutionClass" required placeholder="es. 1A">
                    </div>
                    <div class="form-group">
                        <label for="substitutionSubject">Materia:</label>
                        <input type="text" id="substitutionSubject" required placeholder="es. Matematica">
                    </div>
                    <div class="form-group">
                        <label for="replacedTeacher">Docente Sostituito:</label>
                        <input type="text" id="replacedTeacher" required placeholder="Nome del docente sostituito">
                    </div>
                    <div class="form-group">
                        <label for="substituteTeacher">Docente Sostituto:</label>
                        <input type="text" id="substituteTeacher" required placeholder="Nome del docente sostituto">
                    </div>
                </form>
            </div>
            <div class="form-actions">
                <button type="button" class="cancel-button" onclick="closeFloatingForm('substitutionForm')">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button type="submit" form="substitutionFormContent" class="save-button">
                    <i class="fas fa-save"></i> Salva
                </button>
            </div>
        </div>
    </div>

    <script>
        // Funzioni per gestire i form fluttuanti
        function showFloatingForm(formId) {
            const overlay = document.getElementById('formOverlay');
            const form = document.getElementById(formId);
            
            // Nascondi tutti gli altri form attivi
            document.querySelectorAll('.floating-form.active').forEach(f => {
                if (f.id !== formId) {
                    f.classList.remove('active');
                }
            });
            
            // Mostra l'overlay e il form
            overlay.classList.add('active');
            form.classList.add('active');
            
            // Imposta la data odierna come default per i campi data
            const dateInputs = form.querySelectorAll('input[type="date"]');
            const today = new Date().toISOString().split('T')[0];
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });

            // Scrolla in cima al form
            form.scrollTop = 0;

            // Aggiungi event listener per chiudere il form quando si clicca sull'overlay
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    closeFloatingForm(formId);
                }
            };

            // Aggiungi event listener per chiudere il form con il tasto ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeFloatingForm(formId);
                }
            });
        }

        function closeFloatingForm(formId) {
            const overlay = document.getElementById('formOverlay');
            const form = document.getElementById(formId);
            
            // Rimuovi le classi active
            overlay.classList.remove('active');
            form.classList.remove('active');
            
            // Rimuovi gli event listener
            overlay.onclick = null;
            document.removeEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeFloatingForm(formId);
                }
            });
            
            // Resetta il form
            const formElement = form.querySelector('form');
            if (formElement) {
                formElement.reset();
            }
            const filePreview = form.querySelector('.file-preview');
            if (filePreview) {
                filePreview.innerHTML = '';
            }
        }

        // Aggiungi funzione per chiudere tutti i form
        function closeAllForms() {
            const overlay = document.getElementById('formOverlay');
            document.querySelectorAll('.floating-form.active').forEach(form => {
                form.classList.remove('active');
            });
            overlay.classList.remove('active');
        }

        // Modifica gli event listener dei pulsanti di chiusura
        document.querySelectorAll('.close-button').forEach(button => {
            button.onclick = function() {
                const form = this.closest('.floating-form');
                if (form) {
                    closeFloatingForm(form.id);
                }
            };
        });

        // Aggiungi event listener per chiudere i form quando si clicca fuori
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('form-overlay')) {
                closeAllForms();
            }
        });

        // Modifica le funzioni esistenti per usare i nuovi form fluttuanti
        window.addCarouselItem = () => {
            showFloatingForm('carouselForm');
        };

        window.addCalendarEvent = () => {
            showFloatingForm('calendarForm');
        };

        window.addSubstitution = () => {
            showFloatingForm('substitutionForm');
        };

        // Funzione per mostrare messaggi di feedback
        function showFeedback(message, type = 'info') {
            console.log(`Showing ${type} feedback:`, message);
            const feedback = document.createElement('div');
            feedback.className = `feedback-message ${type}`;
            feedback.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            // Rimuovi eventuali messaggi precedenti
            document.querySelectorAll('.feedback-message').forEach(msg => msg.remove());
            
            document.body.appendChild(feedback);
            
            // Aggiungi stili per il feedback
            feedback.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 
                             type === 'error' ? 'rgba(244, 67, 54, 0.9)' : 
                             'rgba(33, 150, 243, 0.9)'};
                color: white;
                z-index: 9999;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease-out;
            `;
            
            setTimeout(() => {
                feedback.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => feedback.remove(), 300);
            }, 5000);
        }

        // Aggiorna le funzioni di gestione degli eventi per usare il nuovo sistema di feedback
        window.showSuccess = (message) => showFeedback(message, 'success');
        window.showError = (message) => showFeedback(message, 'error');
        window.showInfo = (message) => showFeedback(message, 'info');

        // Funzione per gestire lo scroll-to-top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Mostra/nascondi il pulsante scroll-to-top
        window.onscroll = function() {
            const scrollTop = document.getElementById('scrollTop');
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollTop.classList.add('visible');
            } else {
                scrollTop.classList.remove('visible');
            }
        };
    </script>

    <!-- Aggiungi il pulsante scroll-to-top prima della chiusura del body -->
    <button id="scrollTop" class="scroll-top" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html> 