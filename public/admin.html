<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Totem</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container glass-effect">
        <div class="header">
            <a href="index.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
                <span>Torna alla Home</span>
            </a>
            <div class="logo-container">
                <img src="https://www.istitutoboselli.edu.it/wp-content/uploads/2024/04/logo-boselli-ritaglio-1.png" alt="Logo IIS P.Boselli" class="school-logo">
            </div>
            <div class="admin-header-controls">
                <span id="adminUser" class="admin-user"></span>
                <button onclick="handleLogout()" class="admin-button-small">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
            <i class="fas fa-cog music-icon"></i>
            <h1>Admin Panel</h1>
            <div class="subtitle">Gestione Sistema Totem</div>
        </div>

        <div id="adminContent" class="admin-panel" style="display: none;">
            <!-- Carousel Management Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-images"></i> Gestione Carosello</h2>
                <div class="admin-controls">
                    <div class="location-selector">
                        <label for="carouselLocation">Seleziona Sede:</label>
                        <select id="carouselLocation" onchange="loadCarouselContent()">
                            <option value="viasansovino">Via Sansovino</option>
                            <option value="vialuini">Via Luini</option>
                        </select>
                    </div>
                    <div class="action-buttons">
                        <button onclick="addCarouselItem()" class="admin-button-small">
                            <i class="fas fa-plus"></i> Nuovo Contenuto
                        </button>
                    </div>
                </div>
                <div id="carouselItemsList" class="carousel-items-list">
                    <!-- Carousel items will be loaded here -->
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-calendar-alt"></i> Gestione Calendario</h2>
                <div class="admin-controls">
                    <div class="filters">
                        <div class="location-filter">
                            <label for="calendarLocationFilter">Filtra per Sede:</label>
                            <select id="calendarLocationFilter" onchange="filterCalendarEvents()">
                                <option value="all">Tutte le Sedi</option>
                                <option value="TO1">TO1</option>
                                <option value="TO2">TO2</option>
                                <option value="TO3">TO3</option>
                            </select>
                        </div>
                        <div class="date-filter">
                            <label for="calendarDateFilter">Filtra per Data:</label>
                            <input type="date" id="calendarDateFilter" onchange="filterCalendarEvents()">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="addCalendarEvent()" class="admin-button-small">
                            <i class="fas fa-plus"></i> Nuovo Evento
                        </button>
                    </div>
                </div>
                <div id="calendarEventsList" class="substitutions-list">
                    <!-- Calendar events will be loaded here -->
                </div>
            </div>

            <!-- Substitutions Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-exchange-alt"></i> Gestione Sostituzioni</h2>
                <div class="admin-controls">
                    <div class="filters">
                        <div class="location-filter">
                            <label for="adminLocationFilter">Filtra per Sede:</label>
                            <select id="adminLocationFilter" onchange="filterAdminSubstitutions()">
                                <option value="all">Tutte le Sedi</option>
                                <option value="TO1">TO1</option>
                                <option value="TO2">TO2</option>
                                <option value="TO3">TO3</option>
                            </select>
                        </div>
                        <div class="date-filter">
                            <label for="adminDateFilter">Filtra per Data:</label>
                            <input type="date" id="adminDateFilter" onchange="filterAdminSubstitutions()">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="addSubstitution()" class="admin-button-small">
                            <i class="fas fa-plus"></i> Nuova Sostituzione
                        </button>
                        <button onclick="exportSubstitutions()" class="admin-button-small">
                            <i class="fas fa-download"></i> Esporta Sostituzioni
                        </button>
                    </div>
                </div>
                <div id="substitutionsList" class="substitutions-list">
                    <!-- Substitutions will be loaded here -->
                </div>
            </div>

            <!-- Organizational Structure Section -->
            <div class="admin-section glass-effect">
                <h2><i class="fas fa-sitemap"></i> Gestione Organigramma</h2>
                <div class="admin-controls">
                    <button onclick="editOrgStructure()" class="admin-button-small">
                        <i class="fas fa-edit"></i> Modifica Struttura
                    </button>
                    <button onclick="updateOrgStructure()" class="admin-button-small">
                        <i class="fas fa-save"></i> Aggiorna Struttura
                    </button>
                </div>
            </div>
        </div>

        <!-- Substitution Modal -->
        <div id="substitutionModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gestione Sostituzione</h2>
                    <button onclick="closeSubstitutionModal()" class="close-button">&times;</button>
                </div>
                <form id="substitutionForm" onsubmit="handleSubstitutionSubmit(event)">
                    <input type="hidden" id="substitutionId">
                    <div class="form-group">
                        <label for="substitutionDate">Data:</label>
                        <input type="date" id="substitutionDate" required>
                    </div>
                    <div class="form-group">
                        <label for="substitutionLocation">Sede:</label>
                        <select id="substitutionLocation" required>
                            <option value="TO1">TO1</option>
                            <option value="TO2">TO2</option>
                            <option value="TO3">TO3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="substitutionTimeSlot">Orario:</label>
                        <select id="substitutionTimeSlot" required>
                            <option value="1">1° ora (8:00-9:00)</option>
                            <option value="2">2° ora (9:00-10:00)</option>
                            <option value="3">3° ora (10:00-11:00)</option>
                            <option value="4">4° ora (11:00-12:00)</option>
                            <option value="5">5° ora (12:00-13:00)</option>
                            <option value="6">6° ora (13:00-14:00)</option>
                            <option value="7">7° ora (14:00-15:00)</option>
                            <option value="8">8° ora (15:00-16:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="substitutionClass">Classe:</label>
                        <input type="text" id="substitutionClass" required placeholder="es. 1A">
                    </div>
                    <div class="form-group">
                        <label for="substitutionSubject">Materia:</label>
                        <input type="text" id="substitutionSubject" required>
                    </div>
                    <div class="form-group">
                        <label for="replacedTeacher">Docente Sostituito:</label>
                        <input type="text" id="replacedTeacher" required>
                    </div>
                    <div class="form-group">
                        <label for="substituteTeacher">Docente Sostituto:</label>
                        <input type="text" id="substituteTeacher" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="save-button">Salva</button>
                        <button type="button" onclick="closeSubstitutionModal()" class="cancel-button">Annulla</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Calendar Event Modal -->
        <div id="calendarEventModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gestione Evento</h2>
                    <button onclick="closeCalendarEventModal()" class="close-button">&times;</button>
                </div>
                <form id="calendarEventForm" onsubmit="handleCalendarEventSubmit(event)">
                    <input type="hidden" id="eventId">
                    <div class="form-group">
                        <label for="eventDate">Data:</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventLocation">Sede:</label>
                        <select id="eventLocation" required>
                            <option value="all">Tutte le Sedi</option>
                            <option value="TO1">TO1</option>
                            <option value="TO2">TO2</option>
                            <option value="TO3">TO3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventTimeSlot">Orario:</label>
                        <select id="eventTimeSlot" required>
                            <option value="1">1° ora (8:00-9:00)</option>
                            <option value="2">2° ora (9:00-10:00)</option>
                            <option value="3">3° ora (10:00-11:00)</option>
                            <option value="4">4° ora (11:00-12:00)</option>
                            <option value="5">5° ora (12:00-13:00)</option>
                            <option value="6">6° ora (13:00-14:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventTitle">Titolo Evento:</label>
                        <input type="text" id="eventTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDescription">Descrizione:</label>
                        <textarea id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="save-button">Salva</button>
                        <button type="button" onclick="closeCalendarEventModal()" class="cancel-button">Annulla</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Carousel Item Modal -->
        <div id="carouselItemModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gestione Contenuto Carosello</h2>
                    <button onclick="closeCarouselItemModal()" class="close-button">&times;</button>
                </div>
                <form id="carouselItemForm" onsubmit="handleCarouselItemSubmit(event)">
                    <input type="hidden" id="carouselItemId">
                    <div class="form-group">
                        <label for="itemType">Tipo Contenuto:</label>
                        <select id="itemType" required onchange="toggleMediaInput()">
                            <option value="image">Immagine</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="itemTitle">Titolo:</label>
                        <input type="text" id="itemTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="itemFile">File:</label>
                        <input type="file" id="itemFile" accept="image/*,video/*" required>
                        <div id="filePreview" class="file-preview"></div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="save-button">Salva</button>
                        <button type="button" onclick="closeCarouselItemModal()" class="cancel-button">Annulla</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="loginPrompt" class="login-prompt glass-effect">
            <i class="fas fa-lock"></i>
            <h2>Accesso Richiesto</h2>
            <p>Effettua l'accesso per gestire il sistema totem</p>
            <a href="admin-login.html" class="btn">
                <i class="fas fa-sign-in-alt"></i>
                Accedi
            </a>
        </div>

        <footer class="footer glass-effect">
            <p>© 2024 Totem Navigation | IIS P.Boselli Torino | Tutti i diritti riservati</p>
            <p class="footer-sub">Pannello di Amministrazione</p>
        </footer>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBY79WtkjTgPkY8GqbtZGbawL-PQXjgdHA",
            authDomain: "gestione-totem.firebaseapp.com",
            databaseURL: "https://gestione-totem-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gestione-totem",
            storageBucket: "gestione-totem.firebasestorage.app",
            messagingSenderId: "940742220177",
            appId: "1:940742220177:web:ec36d4958f6f02a948a230",
            measurementId: "G-Y4WT9HRDSY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            const loginPrompt = document.getElementById('loginPrompt');
            const adminContent = document.getElementById('adminContent');
            const adminUser = document.getElementById('adminUser');
            
            if (user) {
                loginPrompt.style.display = 'none';
                adminContent.style.display = 'block';
                adminUser.textContent = `Admin: ${user.email}`;
                loadCarouselContent();
                loadSubstitutions('all', new Date().toISOString().split('T')[0]);
                loadCalendarEvents('all', new Date().toISOString().split('T')[0]);
            } else {
                loginPrompt.style.display = 'block';
                adminContent.style.display = 'none';
            }
        });

        // Handle logout
        window.handleLogout = async () => {
            try {
                await auth.signOut();
                window.location.href = 'admin-login.html';
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Errore durante il logout');
            }
        };

        // Carousel Management Functions
        window.addCarouselItem = () => {
            const modal = document.getElementById('carouselItemModal');
            const form = document.getElementById('carouselItemForm');
            
            document.getElementById('carouselItemId').value = '';
            document.getElementById('itemType').value = 'image';
            document.getElementById('itemTitle').value = '';
            document.getElementById('itemFile').value = '';
            document.getElementById('filePreview').innerHTML = '';
            
            modal.style.display = 'block';
        };

        window.closeCarouselItemModal = () => {
            document.getElementById('carouselItemModal').style.display = 'none';
        };

        window.toggleMediaInput = () => {
            const type = document.getElementById('itemType').value;
            const fileInput = document.getElementById('itemFile');
            fileInput.accept = type === 'image' ? 'image/*' : 'video/*';
        };

        window.handleCarouselItemSubmit = async (event) => {
            event.preventDefault();
            
            const location = document.getElementById('carouselLocation').value;
            const itemId = document.getElementById('carouselItemId').value;
            const type = document.getElementById('itemType').value;
            const title = document.getElementById('itemTitle').value;
            const file = document.getElementById('itemFile').files[0];

            if (!file) {
                alert('Seleziona un file');
                return;
            }

            try {
                // Verifica la corrispondenza tra tipo selezionato e tipo di file
                const fileType = file.type;
                if ((type === 'video' && !fileType.startsWith('video/')) ||
                    (type === 'image' && !fileType.startsWith('image/'))) {
                    alert('Il tipo di file non corrisponde al tipo selezionato');
                    return;
                }

                console.log('Caricamento file:', {
                    nome: file.name,
                    tipo: file.type,
                    dimensione: file.size
                }); // Debug log

                // Convert file to base64
                const base64Data = await fileToBase64(file);
                console.log('File convertito in base64, tipo:', type); // Debug log

                // Get current items to determine next order number
                const carouselRef = db.ref(`carousel/${location}`);
                const snapshot = await carouselRef.once('value');
                let nextOrder = 1;
                
                if (snapshot.exists()) {
                    const items = snapshot.val();
                    const orders = Object.values(items).map(item => item.order || 0);
                    nextOrder = Math.max(...orders) + 1;
                }

                // Save item data to Realtime Database
                const itemData = {
                    type,
                    title,
                    data: base64Data,
                    order: nextOrder,
                    fileType: file.type, // Aggiungiamo il tipo di file originale
                    updatedAt: new Date().toISOString()
                };

                if (itemId) {
                    // Update existing item
                    await carouselRef.child(itemId).update(itemData);
                } else {
                    // Add new item
                    await carouselRef.push(itemData);
                }

                closeCarouselItemModal();
                loadCarouselContent();
                showSuccess('Contenuto salvato con successo');
            } catch (error) {
                console.error('Error saving carousel item:', error);
                showError('Errore durante il salvataggio del contenuto: ' + error.message);
            }
        };

        window.deleteCarouselItem = async (location, itemId) => {
            if (confirm('Sei sicuro di voler eliminare questo contenuto?')) {
                try {
                    // Delete item from Database
                    await db.ref(`carousel/${location}/${itemId}`).remove();
                    loadCarouselContent();
                    showSuccess('Contenuto eliminato con successo');
                } catch (error) {
                    console.error('Error deleting carousel item:', error);
                    showError('Errore durante l\'eliminazione del contenuto');
                }
            }
        };

        window.loadCarouselContent = () => {
            const location = document.getElementById('carouselLocation').value;
            const itemsList = document.getElementById('carouselItemsList');
            
            db.ref(`carousel/${location}`).on('value', (snapshot) => {
                itemsList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    itemsList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-images"></i>
                            <p>Nessun contenuto trovato per questa sede</p>
                        </div>
                    `;
                    return;
                }

                // Convert to array and sort by order
                const items = [];
                snapshot.forEach((childSnapshot) => {
                    const item = childSnapshot.val();
                    item.id = childSnapshot.key;
                    items.push(item);
                });
                
                items.sort((a, b) => (a.order || 0) - (b.order || 0));

                items.forEach((item) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'carousel-item-card';
                    
                    const previewContent = item.type === 'image' 
                        ? `<img src="${item.data}" alt="${item.title}" class="carousel-item-preview">`
                        : `<video src="${item.data}" class="carousel-item-preview" muted></video>`;
                    
                    itemElement.innerHTML = `
                        ${previewContent}
                        <div class="carousel-item-info">
                            <div class="carousel-item-title">
                                <span class="item-number">${item.order}</span>
                                ${item.title}
                            </div>
                            <div class="carousel-item-type">
                                <i class="fas fa-${item.type === 'image' ? 'image' : 'video'}"></i>
                                ${item.type === 'image' ? 'Immagine' : 'Video'}
                            </div>
                        </div>
                        <div class="carousel-item-actions">
                            <button onclick="deleteCarouselItem('${location}', '${item.id}')" class="delete-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    itemsList.appendChild(itemElement);
                });
            });
        };

        // File preview
        document.getElementById('itemFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';
            
            console.log('File selezionato:', {
                nome: file.name,
                tipo: file.type,
                dimensione: file.size
            }); // Debug log

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                preview.appendChild(img);
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '200px';
                preview.appendChild(video);
            } else {
                preview.innerHTML = '<p>Tipo di file non supportato</p>';
            }
        });

        // Calendar functions
        window.editCalendar = () => {
            // Implement calendar editing interface
            showInfo('Funzionalità in sviluppo');
        };

        window.exportCalendar = async () => {
            try {
                const events = await exportCalendarData();
                downloadJSON(events, 'calendar.json');
                showSuccess('Calendario esportato con successo');
            } catch (error) {
                console.error('Error exporting calendar:', error);
                showError('Errore nell\'esportazione del calendario');
            }
        };

        // Substitutions functions
        window.addSubstitution = () => {
            const modal = document.getElementById('substitutionModal');
            const form = document.getElementById('substitutionForm');
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('substitutionId').value = '';
            document.getElementById('substitutionDate').value = today;
            document.getElementById('substitutionLocation').value = 'TO1';
            document.getElementById('substitutionTimeSlot').value = '1';
            document.getElementById('substitutionClass').value = '';
            document.getElementById('substitutionSubject').value = '';
            document.getElementById('replacedTeacher').value = '';
            document.getElementById('substituteTeacher').value = '';
            
            modal.style.display = 'block';
        };

        window.editSubstitution = (substitutionId) => {
            const substitutionRef = db.ref(`substitutions/${substitutionId}`);
            substitutionRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const substitution = snapshot.val();
                    const modal = document.getElementById('substitutionModal');
                    
                    document.getElementById('substitutionId').value = substitutionId;
                    document.getElementById('substitutionDate').value = substitution.date;
                    document.getElementById('substitutionLocation').value = substitution.location;
                    document.getElementById('substitutionTimeSlot').value = substitution.timeSlot;
                    document.getElementById('substitutionClass').value = substitution.class;
                    document.getElementById('substitutionSubject').value = substitution.subject;
                    document.getElementById('replacedTeacher').value = substitution.replacedTeacher;
                    document.getElementById('substituteTeacher').value = substitution.substituteTeacher;
                    
                    modal.style.display = 'block';
                }
            });
        };

        window.closeSubstitutionModal = () => {
            document.getElementById('substitutionModal').style.display = 'none';
        };

        window.handleSubstitutionSubmit = async (event) => {
            event.preventDefault();
            
            const substitutionId = document.getElementById('substitutionId').value;
            const substitution = {
                date: document.getElementById('substitutionDate').value,
                location: document.getElementById('substitutionLocation').value,
                timeSlot: document.getElementById('substitutionTimeSlot').value,
                class: document.getElementById('substitutionClass').value,
                subject: document.getElementById('substitutionSubject').value,
                replacedTeacher: document.getElementById('replacedTeacher').value,
                substituteTeacher: document.getElementById('substituteTeacher').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (substitutionId) {
                    // Update existing substitution
                    await db.ref(`substitutions/${substitutionId}/date`).set(substitution.date);
                    await db.ref(`substitutions/${substitutionId}/location`).set(substitution.location);
                    await db.ref(`substitutions/${substitutionId}/timeSlot`).set(substitution.timeSlot);
                    await db.ref(`substitutions/${substitutionId}/class`).set(substitution.class);
                    await db.ref(`substitutions/${substitutionId}/subject`).set(substitution.subject);
                    await db.ref(`substitutions/${substitutionId}/replacedTeacher`).set(substitution.replacedTeacher);
                    await db.ref(`substitutions/${substitutionId}/substituteTeacher`).set(substitution.substituteTeacher);
                    await db.ref(`substitutions/${substitutionId}/updatedAt`).set(substitution.updatedAt);
                } else {
                    // Add new substitution
                    await db.ref('substitutions').push(substitution);
                }
                closeSubstitutionModal();
                loadSubstitutions();
            } catch (error) {
                console.error('Error saving substitution:', error);
                alert('Errore durante il salvataggio della sostituzione');
            }
        };

        window.deleteSubstitution = async (substitutionId) => {
            if (confirm('Sei sicuro di voler eliminare questa sostituzione?')) {
                try {
                    await db.ref(`substitutions/${substitutionId}`).remove();
                    loadSubstitutions();
                    showSuccess('Sostituzione eliminata con successo');
                } catch (error) {
                    console.error('Error deleting substitution:', error);
                    showError('Errore nell\'eliminazione della sostituzione');
                }
            }
        };

        // Function to filter substitutions in admin panel
        window.filterAdminSubstitutions = () => {
            const selectedLocation = document.getElementById('adminLocationFilter').value;
            const selectedDate = document.getElementById('adminDateFilter').value;
            loadSubstitutions(selectedLocation, selectedDate);
        };

        // Function to load and display substitutions with filters
        function loadSubstitutions(location = 'all', date = '') {
            console.log('Loading substitutions with filters:', { location, date }); // Debug log
            const substitutionsRef = db.ref('substitutions');
            const substitutionsQuery = substitutionsRef.orderByChild('date');

            substitutionsQuery.on('value', (snapshot) => {
                console.log('Snapshot received:', snapshot.exists()); // Debug log
                const substitutionsList = document.getElementById('substitutionsList');
                substitutionsList.innerHTML = '';

                const substitutions = [];
                snapshot.forEach((childSnapshot) => {
                    const substitution = childSnapshot.val();
                    console.log('Processing substitution:', substitution); // Debug log
                    // Apply filters
                    if ((location === 'all' || substitution.location === location) &&
                        (!date || substitution.date === date)) {
                        substitution.id = childSnapshot.key;
                        substitutions.push(substitution);
                    }
                });

                console.log('Filtered substitutions:', substitutions); // Debug log

                if (substitutions.length === 0) {
                    substitutionsList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-calendar-check"></i>
                            <p>Nessuna sostituzione trovata con i filtri selezionati</p>
                        </div>
                    `;
                    return;
                }

                // Sort substitutions by date and time slot
                substitutions.sort((a, b) => {
                    if (a.date === b.date) {
                        return parseInt(a.timeSlot) - parseInt(b.timeSlot);
                    }
                    return a.date.localeCompare(b.date);
                });

                // Group substitutions by date
                const groupedSubstitutions = substitutions.reduce((groups, substitution) => {
                    const date = substitution.date;
                    if (!groups[date]) {
                        groups[date] = [];
                    }
                    groups[date].push(substitution);
                    return groups;
                }, {});

                // Create HTML for each date group
                Object.entries(groupedSubstitutions).forEach(([date, dateSubstitutions]) => {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'date-group-header';
                    dateHeader.innerHTML = `
                        <h3>${new Date(date).toLocaleDateString('it-IT', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</h3>
                    `;
                    substitutionsList.appendChild(dateHeader);

                    dateSubstitutions.forEach(substitution => {
                        const substitutionElement = document.createElement('div');
                        substitutionElement.className = 'substitution-item';
                        substitutionElement.innerHTML = `
                            <div class="substitution-info">
                                <div class="substitution-header">
                                    <span class="location">${substitution.location}</span>
                                    <span class="time">${getTimeSlotText(substitution.timeSlot)}</span>
                                </div>
                                <div class="substitution-details">
                                    <span class="class">Classe: ${substitution.class}</span>
                                    <span class="subject">Materia: ${substitution.subject}</span>
                                    <span class="teachers">
                                        <span class="replaced">Sostituito: ${substitution.replacedTeacher}</span>
                                        <span class="substitute">Sostituto: ${substitution.substituteTeacher}</span>
                                    </span>
                                </div>
                            </div>
                            <div class="substitution-actions">
                                <button onclick="editSubstitution('${substitution.id}')" class="edit-button">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteSubstitution('${substitution.id}')" class="delete-button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        substitutionsList.appendChild(substitutionElement);
                    });
                });
            }, (error) => {
                console.error('Error loading substitutions:', error);
                const substitutionsList = document.getElementById('substitutionsList');
                substitutionsList.innerHTML = `
                    <div class="no-data error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Errore nel caricamento delle sostituzioni</p>
                    </div>
                `;
            });
        }

        // Function to get time slot text
        function getTimeSlotText(slot) {
            const timeSlots = {
                1: "8:00-9:00",
                2: "9:00-10:00",
                3: "10:00-11:00",
                4: "11:00-12:00",
                5: "12:00-13:00",
                6: "13:00-14:00",
                7: "14:00-15:00",
                8: "15:00-16:00"
            };
            return timeSlots[slot] || `Ora ${slot}`;
        }

        // Initialize filters and load substitutions when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const adminDateFilter = document.getElementById('adminDateFilter');
            if (adminDateFilter) {
                adminDateFilter.value = today;
                loadSubstitutions('all', today);
            }
        });

        // Load substitutions when admin panel is shown
        auth.onAuthStateChanged((user) => {
            if (user) {
                const today = new Date().toISOString().split('T')[0];
                loadSubstitutions('all', today);
            }
        });

        // Organizational structure functions
        window.editOrgStructure = async () => {
            try {
                const structure = await getOrgStructure();
                if (structure) {
                    // Implement structure editing interface
                    showInfo('Funzionalità in sviluppo');
                }
            } catch (error) {
                console.error('Error loading org structure:', error);
                showError('Errore nel caricamento della struttura');
            }
        };

        window.updateOrgStructure = async () => {
            try {
                // Implement structure update interface
                showInfo('Funzionalità in sviluppo');
            } catch (error) {
                console.error('Error updating org structure:', error);
                showError('Errore nell\'aggiornamento della struttura');
            }
        };

        // Utility functions
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showSuccess(message) {
            alert(message); // Replace with better UI
        }

        function showError(message) {
            alert(message); // Replace with better UI
        }

        function showInfo(message) {
            alert(message); // Replace with better UI
        }

        // Calendar Event Functions
        window.addCalendarEvent = () => {
            const modal = document.getElementById('calendarEventModal');
            const form = document.getElementById('calendarEventForm');
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('eventId').value = '';
            document.getElementById('eventDate').value = today;
            document.getElementById('eventLocation').value = 'all';
            document.getElementById('eventTimeSlot').value = '1';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            
            modal.style.display = 'block';
        };

        window.editCalendarEvent = (eventId) => {
            const eventRef = db.ref(`calendar/${eventId}`);
            eventRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const event = snapshot.val();
                    const modal = document.getElementById('calendarEventModal');
                    
                    document.getElementById('eventId').value = eventId;
                    document.getElementById('eventDate').value = event.date;
                    document.getElementById('eventLocation').value = event.location;
                    document.getElementById('eventTimeSlot').value = event.timeSlot;
                    document.getElementById('eventTitle').value = event.title;
                    document.getElementById('eventDescription').value = event.description || '';
                    
                    modal.style.display = 'block';
                }
            });
        };

        window.closeCalendarEventModal = () => {
            document.getElementById('calendarEventModal').style.display = 'none';
        };

        window.handleCalendarEventSubmit = async (event) => {
            event.preventDefault();
            
            const eventId = document.getElementById('eventId').value;
            const calendarEvent = {
                date: document.getElementById('eventDate').value,
                location: document.getElementById('eventLocation').value,
                timeSlot: document.getElementById('eventTimeSlot').value,
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (eventId) {
                    await db.ref(`calendar/${eventId}/date`).set(calendarEvent.date);
                    await db.ref(`calendar/${eventId}/location`).set(calendarEvent.location);
                    await db.ref(`calendar/${eventId}/timeSlot`).set(calendarEvent.timeSlot);
                    await db.ref(`calendar/${eventId}/title`).set(calendarEvent.title);
                    await db.ref(`calendar/${eventId}/description`).set(calendarEvent.description);
                    await db.ref(`calendar/${eventId}/updatedAt`).set(calendarEvent.updatedAt);
                } else {
                    await db.ref('calendar').push(calendarEvent);
                }
                closeCalendarEventModal();
                loadCalendarEvents();
            } catch (error) {
                console.error('Error saving calendar event:', error);
                alert('Errore durante il salvataggio dell\'evento');
            }
        };

        window.deleteCalendarEvent = async (eventId) => {
            if (confirm('Sei sicuro di voler eliminare questo evento?')) {
                try {
                    await db.ref(`calendar/${eventId}`).remove();
                    loadCalendarEvents();
                } catch (error) {
                    console.error('Error deleting calendar event:', error);
                    alert('Errore durante l\'eliminazione dell\'evento');
                }
            }
        };

        window.filterCalendarEvents = () => {
            const selectedLocation = document.getElementById('calendarLocationFilter').value;
            const selectedDate = document.getElementById('calendarDateFilter').value;
            loadCalendarEvents(selectedLocation, selectedDate);
        };

        function loadCalendarEvents(location = 'all', date = '') {
            console.log('Loading calendar events with filters:', { location, date });
            const eventsRef = db.ref('calendar');
            const eventsQuery = eventsRef.orderByChild('date');

            eventsQuery.on('value', (snapshot) => {
                console.log('Calendar snapshot received:', snapshot.exists());
                const eventsList = document.getElementById('calendarEventsList');
                eventsList.innerHTML = '';

                const events = [];
                snapshot.forEach((childSnapshot) => {
                    const event = childSnapshot.val();
                    console.log('Processing event:', event);
                    if ((location === 'all' || event.location === location) &&
                        (!date || event.date === date)) {
                        event.id = childSnapshot.key;
                        events.push(event);
                    }
                });

                console.log('Filtered events:', events);

                if (events.length === 0) {
                    eventsList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-calendar-check"></i>
                            <p>Nessun evento trovato con i filtri selezionati</p>
                        </div>
                    `;
                    return;
                }

                // Sort events by date and time slot
                events.sort((a, b) => {
                    if (a.date === b.date) {
                        return parseInt(a.timeSlot) - parseInt(b.timeSlot);
                    }
                    return a.date.localeCompare(b.date);
                });

                // Group events by date
                const groupedEvents = events.reduce((groups, event) => {
                    const date = event.date;
                    if (!groups[date]) {
                        groups[date] = [];
                    }
                    groups[date].push(event);
                    return groups;
                }, {});

                // Create HTML for each date group
                Object.entries(groupedEvents).forEach(([date, dateEvents]) => {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'date-group-header';
                    dateHeader.innerHTML = `
                        <h3>${new Date(date).toLocaleDateString('it-IT', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</h3>
                    `;
                    eventsList.appendChild(dateHeader);

                    dateEvents.forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'substitution-item';
                        eventElement.innerHTML = `
                            <div class="substitution-info">
                                <div class="substitution-header">
                                    <span class="location">${event.location === 'all' ? 'Tutte le Sedi' : event.location}</span>
                                    <span class="time">${getTimeSlotText(event.timeSlot)}</span>
                                </div>
                                <div class="substitution-details">
                                    <span class="title">${event.title}</span>
                                    ${event.description ? `<span class="description">${event.description}</span>` : ''}
                                </div>
                            </div>
                            <div class="substitution-actions">
                                <button onclick="editCalendarEvent('${event.id}')" class="edit-button">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteCalendarEvent('${event.id}')" class="delete-button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        eventsList.appendChild(eventElement);
                    });
                });
            }, (error) => {
                console.error('Error loading calendar events:', error);
                const eventsList = document.getElementById('calendarEventsList');
                eventsList.innerHTML = `
                    <div class="no-data error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Errore nel caricamento degli eventi</p>
                    </div>
                `;
            });
        }

        // Initialize calendar filters and load events when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const calendarDateFilter = document.getElementById('calendarDateFilter');
            if (calendarDateFilter) {
                calendarDateFilter.value = today;
                loadCalendarEvents('all', today);
            }
        });

        // Load calendar events when admin panel is shown
        auth.onAuthStateChanged((user) => {
            if (user) {
                const today = new Date().toISOString().split('T')[0];
                loadCalendarEvents('all', today);
            }
        });
    </script>

    <style>
        .admin-section {
            margin: 2rem 0;
            padding: 2rem;
        }

        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .admin-button-small {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .admin-button-small:hover {
            background: var(--primary-color-dark);
            transform: translateY(-2px);
        }

        .admin-button-small i {
            font-size: 1.2rem;
        }

        .login-prompt {
            text-align: center;
            padding: 3rem;
            margin: 2rem auto;
            max-width: 400px;
        }

        .login-prompt i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .admin-header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-user {
            color: #fff;
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            width: 90%;
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 15px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Substitutions List Styles */
        .substitutions-list {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .substitution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .substitution-info {
            flex: 1;
        }

        .substitution-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .substitution-header .location {
            color: var(--primary-color);
            font-weight: 600;
        }

        .substitution-details {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .substitution-actions {
            display: flex;
            gap: 0.5rem;
        }

        .edit-button,
        .delete-button {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .edit-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary-color);
        }

        .delete-button {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }

        .edit-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .delete-button:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        @media screen and (max-width: 768px) {
            .substitution-item {
                flex-direction: column;
                gap: 1rem;
            }

            .substitution-header {
                flex-direction: column;
                gap: 0.25rem;
            }

            .substitution-details {
                flex-direction: column;
                gap: 0.5rem;
            }

            .substitution-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .location-filter,
        .date-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 200px;
        }

        .location-filter select,
        .date-filter input {
            padding: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            flex: 1;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .date-group-header {
            margin: 1.5rem 0 0.5rem 0;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .date-group-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--text-color);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .no-data i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        @media screen and (max-width: 768px) {
            .filters {
                flex-direction: column;
            }

            .location-filter,
            .date-filter {
                width: 100%;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .admin-button-small {
                width: 100%;
            }
        }

        .no-data.error {
            color: #ff6b6b;
        }

        .no-data.error i {
            color: #ff6b6b;
        }

        .events-list {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .event-info {
            flex: 1;
        }

        .event-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .event-header .location {
            color: var(--primary-color);
            font-weight: 600;
        }

        .event-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .event-details .title {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .event-details .description {
            margin: 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .event-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        @media screen and (max-width: 768px) {
            .event-item {
                flex-direction: column;
                gap: 1rem;
            }

            .event-header {
                flex-direction: column;
                gap: 0.25rem;
            }

            .event-actions {
                width: 100%;
                justify-content: flex-end;
                margin-left: 0;
            }
        }

        .carousel-items-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .carousel-item-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            position: relative;
        }

        .carousel-item-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .carousel-item-info {
            margin-bottom: 10px;
        }

        .carousel-item-title {
            display: flex;
            align-items: center;
        }

        .item-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            margin-right: 8px;
            font-size: 0.9em;
        }

        .carousel-item-type {
            font-size: 0.9em;
            color: var(--primary-color);
        }

        .carousel-item-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .file-preview {
            margin-top: 10px;
            max-width: 300px;
            max-height: 200px;
            overflow: hidden;
            border-radius: 5px;
        }

        .file-preview img,
        .file-preview video {
            width: 100%;
            height: auto;
            object-fit: cover;
        }

        .location-selector {
            margin-bottom: 20px;
        }

        .location-selector select {
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</body>
</html> 